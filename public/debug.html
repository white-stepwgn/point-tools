<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Showroom WS デバッグ用</title>
<style>
body { font-family: sans-serif; margin: 20px; }
input { padding: 5px; font-size: 1em; width: 120px; }
button { padding: 5px 10px; font-size: 1em; margin-left: 5px; }
#log { margin-top: 10px; max-height: 600px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; background: #f9f9f9; font-size: 12px; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Showroom WebSocket デバッグ</h2>
<label>Room ID: <input type="text" id="roomInput" placeholder="例: 490133"></label>
<button id="connectRoom">接続</button>

<div id="log"></div>

<script>
let socket = null;
let broadcastKey = null;

// ログ表示
function log(msg) {
    const div = document.createElement("div");
    div.textContent = msg;
    document.getElementById("log").appendChild(div);
    document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
}

// broadcast_key取得
async function fetchBroadcastKey(roomId) {
    try {
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        if (json.broadcast_key) return json.broadcast_key;
        log("broadcast_key 取得失敗");
        return null;
    } catch(e) {
        log("broadcast_key fetch error: " + e);
        return null;
    }
}

// WebSocket接続
async function connect(roomId) {
    broadcastKey = await fetchBroadcastKey(roomId);
    if (!broadcastKey) return;

    if (socket) socket.close();

    socket = new WebSocket("wss://online.showroom-live.com");
    socket.onopen = () => {
        log("WebSocket OPEN");
        socket.send("SUB\t" + broadcastKey);
    };

    // すべてのWSメッセージをログ出力
    socket.onmessage = (event) => {
        try {
            const msg = JSON.parse(event.data);
            log("WS(JSON): " + JSON.stringify(msg));
        } catch (e) {
            log("WS(raw): " + event.data);
        }
    };

    socket.onclose = () => log("WebSocket CLOSED");
}

// ボタン押下で接続
document.getElementById("connectRoom").onclick = () => {
    const roomId = document.getElementById("roomInput").value.trim();
    if (roomId) connect(roomId);
};
</script>

</body>
</html>
