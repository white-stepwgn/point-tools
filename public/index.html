<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>SR „Ç≥„É°„É≥„Éà„Éª„ÇÆ„Éï„Éà 3„Ç´„É©„É† + Ë®≠ÂÆö„Éë„Éç„É´</title>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
        }

        header {
            /* position: fixed; removed */
            width: 100%;
            background: #ddd;
            padding: 5px 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
            /* Prevent shrinking */
            box-sizing: border-box;
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        input {
            padding: 3px;
            font-size: 1em;
            width: 100px;
        }

        button {
            padding: 3px 8px;
            font-size: 1em;
        }

        .container {
            display: flex;
            gap: 10px;
            /* margin-top: 80px; removed */
            padding: 10px;
            flex: 1;
            /* Fill remaining space */
            overflow: hidden;
            /* Prevent container itself from scrolling */
            min-height: 0;
            /* Important for nested flex scrolling */
        }

        /* ÂêÑ„Ç´„É©„É† */
        .column {
            flex: 1;
            border: 1px solid #ccc;
            background: #fff;
            /* height: 600px; removed */
            height: 100%;
            /* Fill container */
            display: flex;
            flex-direction: column;
            padding: 0;
            min-width: 0;
            /* Prevent flex item overflow */
        }

        /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢Ôºà„Çπ„ÇØ„É≠„Éº„É´ÂØæË±°Ôºâ */
        #comment,
        #freeStar,
        #freeOther,
        #paidGift {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .sticky-header {
            background: #fff;
            z-index: 10;
            padding: 5px;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }

        .sticky-header h2 {
            margin: 0;
            text-align: center;
        }

        /* „Ç≥„É°„É≥„Éà */
        #comment div {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 5px;
            background: #f9f9f9;
            padding: 2px 5px;
            border-radius: 5px;
            box-shadow: 1px 1px 3px #aaa;
        }

        #comment img {
            width: 40px;
            height: 40px;
            margin-right: 5px;
            flex-shrink: 0;
        }

        #comment .comment-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            box-shadow: none;
        }

        #comment .comment-name {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 2px;
            text-align: left;
        }

        #comment .comment-text {
            margin-left: 0;
            margin-top: 0;
        }

        /* „ÇÆ„Éï„Éà */
        .giftItem {
            display: flex;
            align-items: center;
            background: #f9f9f9;
            padding: 2px 5px;
            border-radius: 5px;
            margin-bottom: 5px;
            box-shadow: 1px 1px 3px #aaa;
        }

        .giftItem img {
            width: 40px;
            height: 40px;
            margin-right: 5px;
        }

        /* „ÇÆ„Éï„ÉàÔºà„Ç≥„É°„É≥„ÉàÊ¨Ñ„Å®Âêå„Åò„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */
        #freeStar .giftItem,
        #freeOther .giftItem,
        #paidGift .giftItem {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        #freeStar .giftItem img:first-child,
        #freeOther .giftItem img:first-child,
        #paidGift .giftItem img:first-child {
            width: 40px;
            height: 40px;
            margin-right: 5px;
            flex-shrink: 0;
        }

        #freeStar .giftItem .gift-content,
        #freeOther .giftItem .gift-content,
        #paidGift .giftItem .gift-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-between;
            min-height: 40px;
        }

        #freeStar .giftItem .gift-name,
        #freeOther .giftItem .gift-name,
        #paidGift .giftItem .gift-name {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 2px;
            align-self: flex-start;
            text-align: left;
        }

        #freeStar .giftItem .gift-text,
        #freeOther .giftItem .gift-text,
        #paidGift .giftItem .gift-text {
            margin-left: 0;
            align-self: flex-start;
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        #freeStar .giftItem .gift-text img,
        #freeOther .giftItem .gift-text img,
        #paidGift .giftItem .gift-text img {
            width: 30px;
            height: 30px;
            margin: 0;
        }

        /* „Ç´„É©„É†„Éò„ÉÉ„ÉÄ„Éº */
        .column h2 {
            text-align: center;
            margin: 5px 0;
            font-size: 1.2em;
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        #settingsPanel {
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 0;
            z-index: 99999 !important;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        #settingsPanel div {
            margin-bottom: 5px;
        }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ */
        #statusSpan.connecting {
            color: blue;
        }

        #statusSpan.connected {
            color: green;
        }

        /* „Ç¢„É©„Éº„É†„É¢„Éº„ÉÄ„É´ */
        #alarmModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            text-align: center;
            width: 300px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ÈÄöÁü•„É¢„Éº„ÉÄ„É´ */
        #notificationModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 30px;
            z-index: 2100;
            /* „Ç¢„É©„Éº„É†Ë®≠ÂÆö„Çà„Çä‰∏ä */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            text-align: center;
            width: 320px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #notificationModal h3 {
            margin-top: 0;
            color: #d32f2f;
            font-size: 1.5em;
        }

        #notificationModal p {
            font-size: 1.2em;
            margin: 20px 0;
        }

        #notificationModal button {
            padding: 12px 30px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            background: #2196F3;
            color: white;
            transition: opacity 0.2s;
        }

        #notificationModal button:hover {
            opacity: 0.9;
        }


        /* „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ */
        #commentHistoryModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 2100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            width: 500px;
            max-height: 70vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            flex-direction: column;
        }


        #commentHistoryModal.show {
            display: flex;
        }

        #commentHistoryModal h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #commentHistoryModal .close-btn {
            cursor: pointer;
            font-size: 1.5em;
            color: #999;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #commentHistoryModal .close-btn:hover {
            color: #333;
        }

        #commentHistoryList {
            overflow-y: auto;
            flex: 1;
        }

        #commentHistoryList .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }

        #commentHistoryList .history-time {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        #commentHistoryList .history-text {
            color: #333;
        }

        /* „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ */
        #giftHistoryModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            min-width: 400px;
            max-width: 600px;
        }

        #giftHistoryModal.show {
            display: block;
        }

        #giftHistoryModal h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            color: #333;
        }

        .gift-history-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }

        .gift-history-time {
            font-size: 0.85em;
            color: #999;
            min-width: 80px;
        }

        .gift-history-gift {
            display: flex;
            align-items: center;
            flex: 1;
            margin-left: 10px;
        }

        .gift-history-gift img {
            width: 30px;
            height: 30px;
            margin-right: 8px;
        }

        .gift-history-gift-name {
            font-weight: bold;
            margin-right: 8px;
        }

        .gift-history-count {
            color: #666;
        }

        /* „Ç´„É©„É†„É™„Çµ„Ç§„Ç∂„Éº */
        .col-resizer {
            width: 5px;
            background: #e0e0e0;
            cursor: col-resize;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .col-resizer:hover {
            background: #d0d0d0;
        }

        /* „É™„Çµ„Ç§„Ç∂„Éº */
        #resizer {
            height: 8px;
            background: #e0e0e0;
            cursor: row-resize;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }

        #resizer:hover {
            background: #d0d0d0;
        }

        #resizer::after {
            content: "....";
            color: #999;
            letter-spacing: 2px;
            font-size: 12px;
            line-height: 0;
            margin-top: -8px;
        }

        /* È´òÈ°ç„ÇÆ„Éï„ÉàË°®Á§∫„Ç®„É™„Ç¢ */
        #highValueGiftContainer {
            /* position: fixed; removed */
            /* bottom: 10px; removed */
            /* left: 10px; removed */
            /* max-width: calc(100% - 20px); removed */
            width: 100%;
            height: 150px;
            /* Default height */
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            /* border-radius: 8px; removed */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 99;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .high-value-gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 3px solid #ccc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 100px;
        }

        /* „Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÅÆ„Ç∏„É£„É≥„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes avatarJump {
            0% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-15px);
            }

            60% {
                transform: translateY(-5px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .high-value-gift-item img.avatar.jump {
            animation: avatarJump 0.5s ease-in-out;
        }

        /* ÊîæÁâ©Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÈ†Ü‰ΩçÂ§âÂãïÊôÇÔºâ */
        @keyframes parabolicMove {
            0% {
                transform: translate(var(--move-distance), 0);
            }

            50% {
                transform: translate(calc(var(--move-distance) / 2), -40px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .high-value-gift-item.moving {
            animation: parabolicMove 0.8s cubic-bezier(0.45, 0, 0.55, 1);
            z-index: 100;
            position: relative;
        }

        /* ‰ªñ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅÆÊªë„Çâ„Åã„Å™ÁßªÂãïÔºàJS„ÅßÂà∂Âæ°„Åô„Çã„Åü„ÇÅCSS transition„ÅØÂâäÈô§„Åæ„Åü„ÅØJS„Åß‰∏äÊõ∏„ÅçÔºâ */
        .high-value-gift-item {
            /* transition„ÅØJS„ÅßÂãïÁöÑ„Å´ÈÅ©Áî®„Åó„Åæ„Åô */
        }

        /* ‰∏äÊÆµÔºö„Ç¢„Éê„Çø„Éº„Å®„ÇÆ„Éï„Éà„Ç¢„Ç§„Ç≥„É≥ */
        .high-value-gift-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ÈäÄËâ≤Êû†Ôºà10000pt‰ª•‰∏äÔºâ */
        .high-value-gift-item.silver {
            border-color: #C0C0C0;
            box-shadow: 0 2px 8px rgba(192, 192, 192, 0.5);
        }

        /* „Ç¥„Éº„É´„ÉâÊû†Ôºà30000pt‰ª•‰∏äÔºâ */
        .high-value-gift-item.gold {
            border-color: #FFD700;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.6);
        }

        .high-value-gift-item img.avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .high-value-gift-item img.gift {
            width: 35px;
            height: 35px;
        }

        .high-value-gift-item .count {
            font-weight: bold;
            color: #d00;
            font-size: 1.1em;
            text-align: center;
        }

        /* È´òÈ°ç„ÇÆ„Éï„ÉàÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .high-value-popup {
            position: fixed;
            background: white;
            border: 3px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 250px;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .high-value-popup.show {
            display: flex;
        }

        .high-value-popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }

        .high-value-popup-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .high-value-popup-user {
            font-weight: bold;
            font-size: 1.1em;
        }

        .high-value-popup-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: calc(80vh - 120px);
            padding-right: 5px;
        }

        .high-value-popup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .high-value-popup-label {
            color: #666;
            font-size: 0.9em;
        }

        .high-value-popup-value {
            font-weight: bold;
            font-size: 1em;
        }

        .high-value-popup-close {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 1.5em;
            color: #999;
            font-weight: bold;
        }

        .high-value-popup-close:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        #alarmModal h3 {
            margin-top: 0;
        }

        #alarmModal input[type="text"] {
            font-size: 2.5em;
            padding: 15px;
            margin: 10px 0 20px 0;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            letter-spacing: 2px;
            font-weight: 300;
            background: transparent;
            border: none;
            border-bottom: 2px solid #eee;
            color: #333;
            outline: none;
        }

        /* „ÉÜ„É≥„Ç≠„Éº */
        .tenkey-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .tenkey-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5em;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            transition: background 0.2s, transform 0.1s;
            color: #333;
        }

        .tenkey-btn:hover {
            background: #e0e0e0;
        }

        .tenkey-btn:active {
            background: #d0d0d0;
            transform: scale(0.95);
        }

        .tenkey-btn.clear {
            background: #fff0f0;
            color: #d32f2f;
            font-size: 1em;
            font-weight: bold;
        }

        .tenkey-btn.clear:hover {
            background: #ffcccc;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-header-buttons {
            display: flex;
            align-items: center;
        }

        #alarmModal .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        #alarmModal button.action-btn {
            flex: 1;
            padding: 12px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        #alarmModal button.action-btn:hover {
            opacity: 0.8;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1500;
        }

        /* t18„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´ */
        .t18-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #FF6C1A;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            flex-direction: column;
        }

        .t18-modal.show {
            display: flex;
        }

        .t18-modal-header {
            background: linear-gradient(135deg, #FF6C1A 0%, #FF8C42 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            cursor: move;
            user-select: none;
        }

        .t18-modal-close {
            cursor: pointer;
            font-size: 1.5em;
            color: white;
            font-weight: bold;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .t18-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .t18-modal-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .t18-message-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: rgba(255, 108, 26, 0.1);
            font-weight: bold;
        }

        .t18-message-time {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 5px;
            font-weight: normal;
        }

        .t18-message-text {
            color: #FF6C1A;
        }

        .t18-no-messages {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 1.1em;
        }
    </style>
</head>

<body>

    <div id="overlay"></div>

    <!-- Ë®≠ÂÆö„Éë„Éç„É´Ôºàbody„ÅÆÁõ¥‰∏ã„Å´ÈÖçÁΩÆÔºâ -->
    <div id="settingsPanel"
        style="top: 50%; left: 50%; transform: translate(-50%, -50%); position: fixed; margin: 0; min-width: 300px; z-index: 99999 !important;">
        <div id="settingsHeader"
            style="background: #eee; padding: 5px 10px; cursor: move; border-bottom: 1px solid #ccc; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold;">Ë®≠ÂÆö</span>
            <button id="closeSettings"
                style="border: none; background: none; cursor: pointer; font-size: 1.2em;">‚úï</button>
        </div>
        <div style="padding: 15px;">
            <div><strong>„Ç≥„É°„É≥„Éà:</strong> ÊñáÂ≠ó„Çµ„Ç§„Ç∫ <input type="number" id="commentFontSize" value="14" min="10" max="30"> px
                Ëâ≤ <input type="color" id="commentColor" value="#000000"></div>
            <div style="margin-top: 10px;"><label><input type="checkbox" id="testModeCheckbox">
                    „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºàÈÄö‰ø°ÂÅúÊ≠¢„Éú„Çø„É≥Ë°®Á§∫Ôºâ</label></div>

            <!-- „ÉÜ„Çπ„ÉàÊ©üËÉΩ„Éú„Çø„É≥Ôºà„ÉÜ„Çπ„Éà„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
            <div id="testButtons"
                style="margin-top: 10px; display: none; border-top: 1px solid #eee; padding-top: 10px;">
                <div style="margin-bottom:5px;">
                    <button id="testCommentBtn" style="width:100%; margin-bottom:5px;">„ÉÜ„Çπ„Éà„Ç≥„É°„É≥„Éà</button>
                    <button id="testGiftBtn" style="width:100%;">„ÉÜ„Çπ„Éà„ÇÆ„Éï„ÉàÔºà‰∏ÄÊã¨Ôºâ</button>
                </div>

                <!-- „ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû:</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                        <button class="test-user-btn" data-user-id="1001" data-user-name="„ÉÜ„Çπ„ÉàA"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">A</button>
                        <button class="test-user-btn" data-user-id="1002" data-user-name="„ÉÜ„Çπ„ÉàB"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">B</button>
                        <button class="test-user-btn" data-user-id="1003" data-user-name="„ÉÜ„Çπ„ÉàC"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">C</button>
                        <button class="test-user-btn" data-user-id="1004" data-user-name="„ÉÜ„Çπ„ÉàD"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">D</button>
                        <button class="test-user-btn" data-user-id="1005" data-user-name="„ÉÜ„Çπ„ÉàE"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">E</button>
                        <button class="test-user-btn" data-user-id="1006" data-user-name="„ÉÜ„Çπ„ÉàF"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">F</button>
                    </div>
                </div>

                <!-- ÂÄãÊï∞ÈÅ∏Êäû„Éú„Çø„É≥ -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">ÂÄãÊï∞ÈÅ∏Êäû:</div>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;">
                        <button class="test-count-btn" data-count="1"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó1</button>
                        <button class="test-count-btn" data-count="2"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó2</button>
                        <button class="test-count-btn" data-count="3"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó3</button>
                        <button class="test-count-btn" data-count="4"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó4</button>
                        <button class="test-count-btn" data-count="5"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó5</button>
                        <button class="test-count-btn" data-count="6"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó6</button>
                        <button class="test-count-btn" data-count="7"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó7</button>
                        <button class="test-count-btn" data-count="8"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó8</button>
                        <button class="test-count-btn" data-count="9"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó9</button>
                        <button class="test-count-btn" data-count="10"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó10</button>
                        <button class="test-count-btn" data-count="100"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó100</button>
                        <button class="test-count-btn" data-count="1000"
                            style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: white;">√ó1000</button>
                    </div>
                </div>

                <!-- „ÉÜ„Çπ„Éà„ÇÆ„Éï„Éà„Ç¢„Ç§„Ç≥„É≥ -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">„ÉÜ„Çπ„Éà„ÇÆ„Éï„Éà:</div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                        <img src="https://static.showroom-live.com/image/gift/3000421_s.png?v=7"
                            class="test-gift-icon-new" data-id="3000421" data-type="2" title="ÁÑ°Êñô„ÇÆ„Éï„Éà(Êòü)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3000844_s.png?v=7"
                            class="test-gift-icon-new" data-id="3000844" data-type="2" title="ÁÑ°Êñô„ÇÆ„Éï„Éà(„Åù„ÅÆ‰ªñ)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3_s.png?v=7" class="test-gift-icon-new"
                            data-id="3" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(3)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/800003_s.png?v=7"
                            class="test-gift-icon-new" data-id="800003" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(800003)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/21_s.png?v=7" class="test-gift-icon-new"
                            data-id="21" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(21)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3000349_s.png?v=7"
                            class="test-gift-icon-new" data-id="3000349" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(3000349)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/1601_s.png?v=7" class="test-gift-icon-new"
                            data-id="1601" data-type="2" title="„ÇÆ„Éï„ÉàID 1601"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3000752_s.png?v=7"
                            class="test-gift-icon-new" data-id="3000752" data-type="2" title="ÁÑ°Êñô„ÇÆ„Éï„Éà(3000752)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/800093_s.png?v=7"
                            class="test-gift-icon-new" data-id="800093" data-type="2" title="„ÇÆ„Éï„ÉàID 800093"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/18_s.png?v=7" class="test-gift-icon-new"
                            data-id="18" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(18)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/800072_s.png?v=7"
                            class="test-gift-icon-new" data-id="800072" data-type="1" title="ÊúâÊñô„ÇÆ„Éï„Éà(800072)"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001128_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001128" data-type="2" title="„ÇÆ„Éï„ÉàID 3001128"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001129_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001129" data-type="2" title="„ÇÆ„Éï„ÉàID 3001129"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001130_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001130" data-type="2" title="„ÇÆ„Éï„ÉàID 3001130"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001131_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001131" data-type="2" title="„ÇÆ„Éï„ÉàID 3001131"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001132_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001132" data-type="2" title="„ÇÆ„Éï„ÉàID 3001132"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001133_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001133" data-type="2" title="„ÇÆ„Éï„ÉàID 3001133"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001134_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001134" data-type="2" title="„ÇÆ„Éï„ÉàID 3001134"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001135_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001135" data-type="2" title="„ÇÆ„Éï„ÉàID 3001135"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001136_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001136" data-type="2" title="„ÇÆ„Éï„ÉàID 3001136"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001137_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001137" data-type="2" title="„ÇÆ„Éï„ÉàID 3001137"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                        <img src="https://static.showroom-live.com/image/gift/3001138_s.png?v=7"
                            class="test-gift-icon-new" data-id="3001138" data-type="2" title="„ÇÆ„Éï„ÉàID 3001138"
                            style="width:30px; height:30px; cursor:pointer; border:1px solid #ddd; border-radius:4px;">
                    </div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button id="applyDisplaySettings">ÈÅ©Áî®</button>
            </div>
        </div>
    </div>
    <div id="alarmModal">
        <h3>„Ç¢„É©„Éº„É†Ë®≠ÂÆö</h3>
        <input type="text" id="alarmTimeInput" placeholder="--:--" readonly>

        <div class="tenkey-grid">
            <button class="tenkey-btn" onclick="inputTenkey(1)">1</button>
            <button class="tenkey-btn" onclick="inputTenkey(2)">2</button>
            <button class="tenkey-btn" onclick="inputTenkey(3)">3</button>
            <button class="tenkey-btn" onclick="inputTenkey(4)">4</button>
            <button class="tenkey-btn" onclick="inputTenkey(5)">5</button>
            <button class="tenkey-btn" onclick="inputTenkey(6)">6</button>
            <button class="tenkey-btn" onclick="inputTenkey(7)">7</button>
            <button class="tenkey-btn" onclick="inputTenkey(8)">8</button>
            <button class="tenkey-btn" onclick="inputTenkey(9)">9</button>
            <button class="tenkey-btn clear" onclick="clearTenkey()">C</button>
            <button class="tenkey-btn" onclick="inputTenkey(0)">0</button>
            <button class="tenkey-btn" onclick="backspaceTenkey()">‚å´</button>
        </div>

        <div class="modal-buttons">
            <button id="alarmSetConfirmBtn" class="action-btn" style="background:#4CAF50; color:white;">Ë®≠ÂÆö</button>
            <button id="alarmClearBtn" class="action-btn" style="background:#f44336; color:white;">Ëß£Èô§</button>
        </div>
        <div style="margin-top:15px;">
            <button id="alarmCancelBtn" class="action-btn"
                style="width:100%; background:#9e9e9e; color:white;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div id="notificationModal">
        <h3>üîî „Ç¢„É©„Éº„É†</h3>
        <p id="notificationMessage">ÊôÇÈñì„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ</p>
        <button id="notificationOkBtn">OK</button>
    </div>

    <div id="commentHistoryModal">
        <h3>
            <span id="commentHistoryUser"></span>„ÅÆ„Ç≥„É°„É≥„ÉàÂ±•Ê≠¥
            <button class="close-btn" id="closeCommentHistory">√ó</button>
        </h3>
        <div id="commentHistoryList"></div>
    </div>

    <header>
        <div class="header-row">
            <label>Room ID: <input type="text" id="roomInput" placeholder="‰æã: 490133"></label>
            <button id="switchRoom">Êé•Á∂ö</button>
            <span id="statusSpan" class="disconnected">Status: ÂæÖÊ©ü‰∏≠</span>
            <span id="hbSpan">HB: 10s</span>
            <span id="kpSpan">KeyPoll: 5s</span>
            <span id="roomNameSpan">Room: -</span>
            <span id="currentLiveStartedAtSpan">Êú™ÈÖç‰ø°</span>
            <span id="currentLiveElapsedSpan">ÁµåÈÅéÊôÇÈñì: -</span>
        </div>
        <div class="header-row">
            <span id="clockSpan" style="font-weight:bold; font-size:1.1em;">--:--:--</span>
            <button id="alarmSetBtn">„Ç¢„É©„Éº„É†„Çª„ÉÉ„Éà</button>
            <span id="alarmStatusSpan" style="color: #d00; display:none;">üîî <span id="alarmTimeDisplay"></span></span>
            <button id="pauseBtn" style="background:#ff9800; color:white; margin-left:10px; display:none;">‚è∏
                ÈÄö‰ø°ÂÅúÊ≠¢</button>
        </div>
    </header>

    <div class="container">
        <div class="column">
            <div class="sticky-header"
                style="display:flex; justify-content:space-between; align-items:center; padding:5px 10px;">
                <button id="checkCommentBtn"
                    style="font-size:0.8em; background:#4CAF50; color:white; padding:5px 10px; border:none; border-radius:3px; cursor:pointer;">„Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ</button>
                <h2 style="margin:0; font-size:1.2em;">„Ç≥„É°„É≥„Éà</h2>
                <div style="display:flex; gap:5px;">
                    <button id="scrollTopBtn" style="font-size:0.8em; cursor:pointer;">ÂÖàÈ†≠„Å∏</button>
                    <button id="toggleSettings" style="font-size:0.8em; cursor:pointer;">Ë®≠ÂÆö</button>
                </div>
            </div>
            <div id="comment"></div>
        </div>

        <div class="col-resizer"></div>

        <!-- „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
        <div id="giftHistoryModal" class="modal">
            <h3>„ÇÆ„Éï„ÉàÂ±•Ê≠¥ - <span id="giftHistoryUser"></span></h3>
            <button id="closeGiftHistory" style="position:absolute; top:10px; right:10px; cursor:pointer;">‚úï</button>
            <div id="giftHistoryList" style="max-height:400px; overflow-y:auto; margin-top:10px;"></div>
        </div>



        <div class="column">
            <div class="sticky-header">
                <h2>ÁÑ°Êñô„ÇÆ„Éï„Éà ‚≠ê</h2>
            </div>
            <div id="freeStar"></div>
        </div>

        <div class="col-resizer"></div>

        <div class="column">
            <div class="sticky-header">
                <h2>ÁÑ°Êñô„ÇÆ„Éï„ÉàÔºà„Åù„ÅÆ‰ªñÔºâ</h2>
            </div>
            <div id="freeOther"></div>
        </div>

        <div class="col-resizer"></div>

        <div class="column">
            <div class="sticky-header">
                <h2>ÊúâÊñô„ÇÆ„Éï„Éà</h2>
            </div>
            <div id="paidGift"></div>
        </div>
    </div>


    <div id="resizer"></div>

    <!-- È´òÈ°ç„ÇÆ„Éï„ÉàË°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="highValueGiftContainer"></div>

    <!-- È´òÈ°ç„ÇÆ„Éï„ÉàÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
    <div id="highValuePopup" class="high-value-popup">
        <span class="high-value-popup-close"
            onclick="document.getElementById('highValuePopup').classList.remove('show')">√ó</span>
        <div class="high-value-popup-header">
            <img id="popupAvatar" src="" alt="avatar">
            <div id="popupUserName" class="high-value-popup-user"></div>
        </div>
        <div class="high-value-popup-content">
            <div class="high-value-popup-row">
                <span class="high-value-popup-label">„ÇÆ„Éï„Éà:</span>
                <span id="popupGiftName" class="high-value-popup-value"></span>
            </div>
            <div class="high-value-popup-row">
                <span class="high-value-popup-label">Á¥ØÁ©çÂÄãÊï∞:</span>
                <span id="popupTotalCount" class="high-value-popup-value"></span>
            </div>
            <div class="high-value-popup-row">
                <span class="high-value-popup-label">Âü∫Êú¨ÈáëÈ°ç:</span>
                <span id="popupBasePrice" class="high-value-popup-value"></span>
            </div>
            <div class="high-value-popup-row">
                <span class="high-value-popup-label">Á¥ØÁ©ç„Éù„Ç§„É≥„Éà:</span>
                <span id="popupTotalPoints" class="high-value-popup-value"></span>
            </div>
        </div>
    </div>

    <!-- t18„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´ -->
    <div id="t18Modal" class="t18-modal">
        <div class="t18-modal-header">
            <span>„Ç∑„Çπ„ÉÜ„É†„Ç≥„É°„É≥„Éàüí¨</span>
            <button class="t18-modal-close" onclick="document.getElementById('t18Modal').classList.remove('show');">
                √ó
            </button>
        </div>
        <div class="t18-modal-content" id="t18ModalContent">
            <div class="t18-no-messages">„Åæ„Å†„Éï„Ç°„É≥„É¨„Éô„É´„Ç¢„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
    </div>

    <script>
        let broadcastKey = null;
        let socket = null;
        let startedAt = null;
        let hbInterval = null;
        let reconnectTimeout = null;

        // È´òÈ°ç„ÇÆ„Éï„Éà„É¶„Éº„Ç∂„ÉºÈõÜË®à { userId: { totalPoints, totalCount, bestGift: {id, point, name}, gifts: { giftId: count } } }
        const userHighValueData = {};

        // „Ç¢„É©„Éº„É†Áî®
        let alarmTime = null; // "HH:MM" string
        let alarmTriggered = false;

        // t18„É°„ÉÉ„Çª„Éº„Ç∏Â±•Ê≠¥ [{ message, color, time }]
        const t18MessageHistory = [];

        // ÊôÇË®àÊõ¥Êñ∞
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("clockSpan").textContent = `${h}:${m}:${s}`;

            // „Ç¢„É©„Éº„É†„ÉÅ„Çß„ÉÉ„ÇØ
            if (alarmTime && !alarmTriggered) {
                const currentHM = `${h}:${m}`;
                if (currentHM === alarmTime) {
                    alarmTriggered = true;
                    // alert(`„Ç¢„É©„Éº„É†: ${alarmTime} „Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`); // ÂªÉÊ≠¢

                    // „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                    document.getElementById("notificationMessage").textContent = `${alarmTime} „Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`;
                    document.getElementById("notificationModal").style.display = "block";
                    document.getElementById("overlay").style.display = "block";

                    // „Ç¢„É©„Éº„É†„É™„Çª„ÉÉ„Éà
                    alarmTime = null;
                    document.getElementById("alarmStatusSpan").style.display = "none";
                }
            }
        }, 1000);

        // ÈÄöÁü•„É¢„Éº„ÉÄ„É´„ÅÆOK„Éú„Çø„É≥
        document.getElementById("notificationOkBtn").onclick = () => {
            document.getElementById("notificationModal").style.display = "none";
            // „Ç¢„É©„Éº„É†Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇÇÈñâ„Åò„Çã
            if (document.getElementById("alarmModal").style.display !== "block") {
                document.getElementById("overlay").style.display = "none";
            }
        };

        // „Ç¢„É©„Éº„É†Ë®≠ÂÆö„Éú„Çø„É≥Ôºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ
        const alarmModal = document.getElementById("alarmModal");
        const overlay = document.getElementById("overlay");
        const alarmTimeInput = document.getElementById("alarmTimeInput");

        let tenkeyBuffer = ""; // ÂÖ•Âäõ„Éê„ÉÉ„Éï„Ç° (‰æã: "1230")

        function updateTimeDisplay() {
            // „Éê„ÉÉ„Éï„Ç°„Çí HH:MM ÂΩ¢Âºè„Å´Êï¥ÂΩ¢„Åó„Å¶Ë°®Á§∫
            let display = "--:--";
            if (tenkeyBuffer.length > 0) {
                let h = tenkeyBuffer.substring(0, 2);
                let m = tenkeyBuffer.substring(2, 4);

                // „Éë„Éá„Ç£„É≥„Ç∞„ÇÑ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂá¶ÁêÜ
                if (tenkeyBuffer.length === 1) display = `${h}-:--`;
                else if (tenkeyBuffer.length === 2) display = `${h}:--`;
                else if (tenkeyBuffer.length === 3) display = `${h}:${m.charAt(0)}-`;
                else if (tenkeyBuffer.length === 4) display = `${h}:${m}`;
            }
            alarmTimeInput.value = display;
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨ÈñãÔºàHTML„ÅÆonclick„Åã„ÇâÂëº„Å∂„Åü„ÇÅÔºâ
        window.inputTenkey = (num) => {
            if (tenkeyBuffer.length < 4) {
                tenkeyBuffer += num;
                updateTimeDisplay();
            }
        };

        window.clearTenkey = () => {
            tenkeyBuffer = "";
            updateTimeDisplay();
        };

        window.backspaceTenkey = () => {
            if (tenkeyBuffer.length > 0) {
                tenkeyBuffer = tenkeyBuffer.slice(0, -1);
                updateTimeDisplay();
            }
        };

        function closeAlarmModal() {
            alarmModal.style.display = "none";
            overlay.style.display = "none";
        }

        document.getElementById("alarmSetBtn").onclick = () => {
            // ÂàùÊúüÂåñ
            tenkeyBuffer = "";

            // ÁèæÂú®ÊôÇÂàª„ÇíÂàùÊúüÂÄ§„Å®„Åó„Å¶„Çª„ÉÉ„Éà„Åô„Çã„Åã„ÄÅÁ©∫„Å´„Åô„Çã„Åã
            // „ÉÜ„É≥„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØÁ©∫„ÅÆÊñπ„ÅåÊâì„Å°„ÇÑ„Åô„ÅÑ„Åã„ÇÇÔºü
            // Ë¶ÅÊúõ„Åå„ÅÇ„Çå„Å∞ÁèæÂú®ÊôÇÂàª„Çª„ÉÉ„Éà„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ‰ªäÂõû„ÅØÁ©∫„Çπ„Çø„Éº„Éà„Å´„Åô„Çã

            updateTimeDisplay();

            alarmModal.style.display = "block";
            overlay.style.display = "block";
        };

        // Ë®≠ÂÆöÁ¢∫ÂÆö
        // Ë®≠ÂÆöÁ¢∫ÂÆö
        document.getElementById("alarmSetConfirmBtn").onclick = () => {
            if (tenkeyBuffer.length === 4) {
                const h = parseInt(tenkeyBuffer.substring(0, 2));
                const m = parseInt(tenkeyBuffer.substring(2, 4));

                // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
                    alarmTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    alarmTriggered = false;
                    document.getElementById("alarmTimeDisplay").textContent = alarmTime;
                    document.getElementById("alarmStatusSpan").style.display = "inline";
                    closeAlarmModal();
                } else {
                    alert("ÁÑ°Âäπ„Å™ÊôÇÂàª„Åß„Åô");
                }
            } else {
                alert("ÊôÇÂàª„Çí4Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (‰æã: 1230)");
            }
        };

        // Ëß£Èô§
        document.getElementById("alarmClearBtn").onclick = () => {
            alarmTime = null;
            document.getElementById("alarmStatusSpan").style.display = "none";
            closeAlarmModal();
        };

        // „Ç≠„É£„É≥„Çª„É´
        document.getElementById("alarmCancelBtn").onclick = closeAlarmModal;
        overlay.onclick = closeAlarmModal;

        // Ë®≠ÂÆö
        let commentSettings = { size: 14, color: "#000000" };

        // „ÇÆ„Éï„ÉàÁ¥ØÁ©çÁÆ°ÁêÜ
        const paidGiftMap = {};
        const freeGiftMap = {};
        const freeStarMap = {};   // ID:3000421 „ÅÆÁÑ°Êñô„ÇÆ„Éï„Éà
        const freeOtherMap = {};  // „Åù„Çå‰ª•Â§ñ„ÅÆÁÑ°Êñô„ÇÆ„Éï„Éà

        // „ÇÆ„Éï„Éà„Éû„Çπ„Çø„Éº„Éá„Éº„Çø (ID -> {name, point, free})
        const giftMasterData = {};

        // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ (user_id -> [{time, name, text}, ...])
        const commentHistory = {};

        // „ÇÆ„Éï„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ (user_id -> [{time, name, giftId, giftName, count, type}, ...])
        const giftHistory = {};

        // „Ç≥„É°„É≥„ÉàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÁî® (comment_id„Åæ„Åü„ÅØ„Éè„ÉÉ„Ç∑„É•ÂÄ§„Çí‰øùÂ≠ò)
        const receivedComments = new Set();
        let commentLogInterval = null;
        let currentRoomId = null;
        let isPaused = false; // ÈÄö‰ø°‰∏ÄÊôÇÂÅúÊ≠¢„Éï„É©„Ç∞




        // Ë®≠ÂÆö„Éë„Éç„É´Ë°®Á§∫
        const settingsPanel = document.getElementById("settingsPanel");

        // Ë®≠ÂÆö„Éë„Éç„É´„ÅÆ‰ΩçÁΩÆ„ÇíÁîªÈù¢ÂÜÖ„Å´Ë™øÊï¥„Åô„ÇãÈñ¢Êï∞
        function adjustSettingsPanelPosition() {
            // transform„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂàùÊúüÁä∂ÊÖãÔºâ
            if (settingsPanel.style.transform && settingsPanel.style.transform !== "none") {
                return;
            }

            const currentLeft = parseFloat(settingsPanel.style.left) || 0;
            const currentTop = parseFloat(settingsPanel.style.top) || 0;
            const panelWidth = settingsPanel.offsetWidth;
            const panelHeight = settingsPanel.offsetHeight;

            const maxLeft = window.innerWidth - panelWidth;
            const maxTop = window.innerHeight - panelHeight;

            let newLeft = Math.max(0, Math.min(currentLeft, maxLeft));
            let newTop = Math.max(0, Math.min(currentTop, maxTop));

            settingsPanel.style.left = `${newLeft}px`;
            settingsPanel.style.top = `${newTop}px`;
        }

        document.getElementById("toggleSettings").onclick = () => {
            if (settingsPanel.style.display === "none" || settingsPanel.style.display === "") {
                // „Åæ„ÅöË°®Á§∫
                settingsPanel.style.display = "block";

                // „É™„Éï„É≠„Éº„ÇíÂº∑Âà∂
                void settingsPanel.offsetHeight;

                // „Éë„Éç„É´„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                const panelWidth = settingsPanel.offsetWidth;
                const panelHeight = settingsPanel.offsetHeight;

                // ‰∏≠Â§Æ„Å´ÈÖçÁΩÆÔºàtransform„ÅØ‰Ωø„Çè„Å™„ÅÑÔºâ
                const centerLeft = Math.max(0, (window.innerWidth - panelWidth) / 2);
                const centerTop = Math.max(0, (window.innerHeight - panelHeight) / 2);

                settingsPanel.style.transform = "none";
                settingsPanel.style.left = `${centerLeft}px`;
                settingsPanel.style.top = `${centerTop}px`;
            } else {
                settingsPanel.style.display = "none";
            }
        };

        document.getElementById("closeSettings").onclick = (e) => {
            e.stopPropagation(); // „Ç§„Éô„É≥„Éà„ÅÆ„Éê„Éñ„É™„É≥„Ç∞„ÇíÈò≤„Åê
            settingsPanel.style.display = "none";
        };

        // ‚úï„Éú„Çø„É≥„ÅÆmousedown„Ç§„Éô„É≥„Éà„Åß„ÇÇ„Éê„Éñ„É™„É≥„Ç∞„ÇíÈò≤„Åê
        document.getElementById("closeSettings").addEventListener("mousedown", (e) => {
            e.stopPropagation(); // „Éâ„É©„ÉÉ„Ç∞„ÅåÈñãÂßã„Åï„Çå„Çã„ÅÆ„ÇíÈò≤„Åê
        });

        // Ë®≠ÂÆöÈÅ©Áî®
        document.getElementById("applyDisplaySettings").onclick = () => {
            commentSettings.size = parseInt(document.getElementById("commentFontSize").value);
            commentSettings.color = document.getElementById("commentColor").value;

            document.getElementById("comment").style.fontSize = commentSettings.size + "px";
            document.getElementById("comment").style.color = commentSettings.color;

            // „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºàÈÄö‰ø°ÂÅúÊ≠¢„Éú„Çø„É≥Ë°®Á§∫ÔºâÂàá„ÇäÊõø„Åà
            const isTestMode = document.getElementById("testModeCheckbox").checked;
            document.getElementById("pauseBtn").style.display = isTestMode ? "inline-block" : "none";
            document.getElementById("testButtons").style.display = isTestMode ? "block" : "none";

            // „Éë„Éç„É´„ÇíÈñâ„Åò„Çã
            settingsPanel.style.display = "none";
        };

        // „ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÊ©üËÉΩ
        let selectedTestUser = { u: 1001, ac: "„ÉÜ„Çπ„ÉàA", av: 1 };

        document.querySelectorAll(".test-user-btn").forEach(btn => {
            btn.onclick = () => {
                // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíËß£Èô§
                document.querySelectorAll(".test-user-btn").forEach(b => {
                    b.style.background = "white";
                    b.style.borderColor = "#ddd";
                    b.style.color = "#333";
                    b.style.fontWeight = "normal";
                });

                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                btn.style.background = "#4CAF50";
                btn.style.borderColor = "#4CAF50";
                btn.style.color = "white";
                btn.style.fontWeight = "bold";

                // ÈÅ∏Êäû„Åï„Çå„Åü„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò
                selectedTestUser = {
                    u: parseInt(btn.getAttribute("data-user-id")),
                    ac: btn.getAttribute("data-user-name"),
                    av: parseInt(btn.getAttribute("data-user-id")) % 100 // „Ç¢„Éê„Çø„ÉºID„ÅØÈÅ©ÂΩì„Å´Ë®≠ÂÆö
                };
            };
        });

        // ÂàùÊúüÈÅ∏ÊäûÔºà„É¶„Éº„Ç∂„ÉºAÔºâ
        document.querySelector(".test-user-btn[data-user-id='1001']").click();

        // „ÉÜ„Çπ„Éà„Ç≥„É°„É≥„ÉàÊ©üËÉΩ
        document.getElementById("testCommentBtn").onclick = () => {
            const testComment = {
                u: selectedTestUser.u,
                ac: selectedTestUser.ac,
                cm: "„ÉÜ„Çπ„Éà„Ç≥„É°„É≥„Éà " + new Date().toLocaleTimeString(),
                av: selectedTestUser.av,
                created_at: Math.floor(Date.now() / 1000)
            };
            showComment(testComment);
        };

        // „ÉÜ„Çπ„Éà„ÇÆ„Éï„ÉàÊ©üËÉΩ
        document.getElementById("testGiftBtn").onclick = () => {
            const now = Math.floor(Date.now() / 1000);

            // ÁÑ°Êñô„ÇÆ„Éï„Éà „ÇÆ„Éï„ÉàID3000421√ó100ÂÄã
            showGift({ ...selectedTestUser, g: 3000421, n: 100, created_at: now, gt: 2 });

            // ÁÑ°Êñô„ÇÆ„Éï„Éà„Åù„ÅÆ‰ªñ „ÇÆ„Éï„ÉàID3000844√ó10ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 3000844, n: 10, created_at: now, gt: 2 });
            }, 100);

            // ÊúâÊñô„ÇÆ„Éï„Éà „ÇÆ„Éï„ÉàID 3√ó10ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 3, n: 10, created_at: now, gt: 1 });
            }, 200);

            // ÊúâÊñô„ÇÆ„Éï„Éà „ÇÆ„Éï„ÉàID 800003√ó1ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 800003, n: 1, created_at: now, gt: 1 });
            }, 300);

            // ÊúâÊñô„ÇÆ„Éï„Éà „ÇÆ„Éï„ÉàID 21√ó1ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 21, n: 1, created_at: now, gt: 1 });
            }, 400);

            // ÊúâÊñô„ÇÆ„Éï„Éà „ÇÆ„Éï„ÉàID 3000349√ó1ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 3000349, n: 1, created_at: now, gt: 1 });
            }, 500);

            // ÁÑ°Êñô„ÇÆ„Éï„Éà„Åù„ÅÆ‰ªñ „ÇÆ„Éï„ÉàID 3000752√ó1ÂÄã
            setTimeout(() => {
                showGift({ ...selectedTestUser, g: 3000752, n: 1, created_at: now, gt: 2 });
            }, 600);

            // ÁÑ°Êñô„ÇÆ„Éï„Éà„Åù„ÅÆ‰ªñ ËøΩÂä†„ÉÜ„Çπ„Éà„ÇÆ„Éï„Éà √ó10ÂÄã„Åö„Å§
            const freeGiftIds = [3000669, 3000670, 3000671, 3000672, 3000673, 3000841, 3000842, 3000843, 3000844, 3000845];
            freeGiftIds.forEach((giftId, index) => {
                setTimeout(() => {
                    showGift({ ...selectedTestUser, g: giftId, n: 10, created_at: now, gt: 2 });
                }, 700 + (index * 100));
            });
        };

        // ÂÄãÊï∞ÈÅ∏Êäû„Éú„Çø„É≥„Å®„ÇÆ„Éï„Éà„Ç¢„Ç§„Ç≥„É≥„ÅÆÊñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†
        let selectedTestCount = 1; // „Éá„Éï„Ç©„É´„Éà„ÅØ√ó1

        // ÂÄãÊï∞ÈÅ∏Êäû„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
        document.querySelectorAll(".test-count-btn").forEach(btn => {
            btn.onclick = () => {
                // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíËß£Èô§
                document.querySelectorAll(".test-count-btn").forEach(b => {
                    b.style.background = "white";
                    b.style.borderColor = "#ddd";
                    b.style.color = "#333";
                    b.style.fontWeight = "normal";
                });

                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                btn.style.background = "#4CAF50";
                btn.style.borderColor = "#4CAF50";
                btn.style.color = "white";
                btn.style.fontWeight = "bold";

                // ÈÅ∏Êäû„Åï„Çå„ÅüÂÄãÊï∞„Çí‰øùÂ≠ò
                selectedTestCount = parseInt(btn.getAttribute("data-count"));
            };
        });

        // ÂàùÊúüÈÅ∏ÊäûÔºà√ó1Ôºâ
        document.querySelector(".test-count-btn[data-count='1']").click();

        // Êñ∞„Åó„ÅÑ„ÇÆ„Éï„Éà„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
        document.querySelectorAll(".test-gift-icon-new").forEach(icon => {
            icon.onclick = () => {
                const giftId = parseInt(icon.getAttribute("data-id"));
                const type = parseInt(icon.getAttribute("data-type"));
                const now = Math.floor(Date.now() / 1000);

                showGift({ ...selectedTestUser, g: giftId, n: selectedTestCount, created_at: now, gt: type });
            };
        });

        // ÂÄãÂà•„ÉÜ„Çπ„Éà„ÇÆ„Éï„Éà„Éú„Çø„É≥ÔºàÂè§„ÅÑ„Ç∑„Çπ„ÉÜ„É†„ÄÅ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        document.querySelectorAll(".test-gift-icon").forEach(icon => {
            icon.onclick = () => {
                const giftId = parseInt(icon.getAttribute("data-id"));
                const count = parseInt(icon.getAttribute("data-count"));
                const type = parseInt(icon.getAttribute("data-type"));
                const now = Math.floor(Date.now() / 1000);

                showGift({ ...selectedTestUser, g: giftId, n: count, created_at: now, gt: type }, type);
            };
        });

        // ÈÄö‰ø°‰∏ÄÊôÇÂÅúÊ≠¢/ÂÜçÈñã„Éú„Çø„É≥
        document.getElementById("pauseBtn").onclick = () => {
            isPaused = !isPaused;
            const btn = document.getElementById("pauseBtn");
            if (isPaused) {
                btn.textContent = "‚ñ∂ ÈÄö‰ø°ÂÜçÈñã";
                btn.style.background = "#4CAF50";
            } else {
                btn.textContent = "‚è∏ ÈÄö‰ø°ÂÅúÊ≠¢";
                btn.style.background = "#ff9800";
            }
        };

        // „Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ„Éú„Çø„É≥
        document.getElementById("checkCommentBtn").onclick = async () => {
            if (!currentRoomId) {
                alert("„É´„Éº„É†„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                return;
            }

            const btn = document.getElementById("checkCommentBtn");
            btn.disabled = true;
            btn.textContent = "„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...";

            try {
                const res = await fetch(`/comment_log?room_id=${currentRoomId}`);
                const json = await res.json();

                if (json && json.comment_log && Array.isArray(json.comment_log)) {
                    const comments = json.comment_log.slice().reverse();
                    let restoredCount = 0;

                    comments.forEach(comment => {
                        // Êäú„Åë„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆÂÜçË°®Á§∫ÈÉ®ÂàÜ„Åß„ÅØ user_id === 0 „ÇíÈô§Â§ñ
                        if (comment.user_id === 0) return;

                        const isDuplicate = Array.from(receivedComments).some(hash => {
                            const firstUnderscore = hash.indexOf('_');
                            const lastUnderscore = hash.lastIndexOf('_');

                            if (firstUnderscore === -1 || lastUnderscore === -1 || firstUnderscore === lastUnderscore) {
                                return false;
                            }

                            const storedUserId = hash.substring(0, firstUnderscore);
                            const storedTimestamp = hash.substring(lastUnderscore + 1);
                            const storedComment = hash.substring(firstUnderscore + 1, lastUnderscore);

                            if (storedUserId == comment.user_id && storedComment === comment.comment) {
                                const timeDiff = Math.abs(parseInt(storedTimestamp) - comment.created_at);
                                return timeDiff <= 5;
                            }
                            return false;
                        });

                        if (!isDuplicate) {
                            const commentHash = `${comment.user_id}_${comment.comment}_${comment.created_at}`;
                            receivedComments.add(commentHash);

                            const commentObj = {
                                u: comment.user_id,
                                ac: comment.name,
                                cm: comment.comment,
                                av: comment.avatar_id,
                                created_at: comment.created_at,
                                fromPolling: true
                            };
                            showComment(commentObj);
                            restoredCount++;
                        }
                    });

                    btn.textContent = `${restoredCount}‰ª∂Âæ©ÂÖÉ`;
                    setTimeout(() => {
                        btn.textContent = "„Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ";
                        btn.disabled = false;
                    }, 2000);
                } else {
                    btn.textContent = "„Ç®„É©„Éº";
                    setTimeout(() => {
                        btn.textContent = "„Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ";
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                console.error("„Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:", e);
                btn.textContent = "„Ç®„É©„Éº";
                setTimeout(() => {
                    btn.textContent = "„Ç≥„É°Êäú„ÉÅ„Çß„ÉÉ„ÇØ";
                    btn.disabled = false;
                }, 2000);
            }
        };

        // ÂÖàÈ†≠„Å∏„Éú„Çø„É≥
        document.getElementById("scrollTopBtn").onclick = () => {
            const commentDiv = document.getElementById("comment");
            commentDiv.scrollTop = 0;
        };



        // „Ç≥„É°„É≥„ÉàË°®Á§∫
        function showComment(c) {
            // "m" „Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁâπÂà•Ë°®Á§∫Ôºà„Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÄÅ„Éï„Ç°„É≥„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å™„Å©Ôºâ
            if (c.m) {
                const div = document.createElement("div");
                div.style.display = "flex";
                div.style.alignItems = "flex-start";
                div.style.marginBottom = "5px";
                div.style.padding = "5px 10px";
                div.style.borderRadius = "5px";
                div.style.boxShadow = "1px 1px 3px #aaa";
                div.style.cursor = "pointer"; // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´„Åô„Çã

                // „Ç´„É©„Éº„Ç≥„Éº„Éâ(c)„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç™„É¨„É≥„Ç∏
                const colorCode = c.c ? `#${c.c}` : "#ff9800";
                const bgColor = c.c ? `#${c.c}20` : "#fff3e0"; // 20„ÅØÈÄèÊòéÂ∫¶(Á¥Ñ12%)

                div.style.background = bgColor;
                div.style.borderLeft = `4px solid ${colorCode}`;

                const textP = document.createElement("p");
                textP.style.margin = "0";
                textP.style.color = colorCode;
                textP.style.fontWeight = "bold";
                textP.textContent = c.m;

                div.appendChild(textP);

                // t18„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Å¶„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
                if (c.t === 18) {
                    t18MessageHistory.unshift({
                        message: c.m,
                        color: colorCode,
                        time: c.created_at ? new Date(c.created_at * 1000) : new Date()
                    });
                    // ÊúÄÂ§ß100‰ª∂„Åæ„Åß‰øùÊåÅ
                    if (t18MessageHistory.length > 100) {
                        t18MessageHistory.pop();
                    }

                    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                    div.onclick = () => {
                        showT18Modal();
                    };

                    // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
                    const modal = document.getElementById("t18Modal");
                    if (modal.classList.contains("show")) {
                        updateT18ModalContent();
                    }
                }

                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÁî®„Å´„Ç≥„É°„É≥„Éà„ÇíË®òÈå≤
                const commentHash = `${c.u}_${c.m}_${c.created_at || Date.now()}`;
                receivedComments.add(commentHash);

                document.getElementById("comment").prepend(div);
                return;
            }

            // ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„ÉàË°®Á§∫
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.alignItems = "flex-start";   // ‰∏äÊèÉ„Åà
            div.style.marginBottom = "5px";
            div.style.background = "#f9f9f9";
            div.style.padding = "2px 5px";
            div.style.borderRadius = "5px";
            div.style.boxShadow = "1px 1px 3px #aaa";
            div.style.cursor = "pointer"; // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´„Åô„Çã

            // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±•Ê≠¥Ë°®Á§∫
            div.onclick = () => {
                showCommentHistory(c.u, c.ac, c.av);
            };

            // „Ç¢„Éê„Çø„ÉºÁîªÂÉè
            const img = document.createElement("img");
            img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
            img.style.width = "40px";
            img.style.height = "40px";
            img.style.marginRight = "5px";
            img.style.flexShrink = "0";

            // „Ç≥„É°„É≥„ÉàÂêç„ÉªÊú¨Êñá„É©„ÉÉ„Éë„Éº
            const wrapperDiv = document.createElement("div");
            wrapperDiv.style.display = "flex";
            wrapperDiv.style.flexDirection = "column";
            wrapperDiv.style.alignItems = "flex-start";  // Â∑¶ÂØÑ„Åõ
            wrapperDiv.style.flex = "1";

            const nameSpan = document.createElement("span");
            nameSpan.className = "comment-name";
            nameSpan.style.color = "#999";
            nameSpan.style.fontSize = "0.9em";
            nameSpan.style.marginBottom = "2px";
            nameSpan.style.textAlign = "left";

            // „Éù„Éº„É™„É≥„Ç∞„ÅßË£úÂÆå„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„Å´„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
            if (c.fromPolling) {
                const marker = document.createElement("span");
                marker.textContent = "[Ë£úÂÆå] ";
                marker.style.color = "#ff9800";
                marker.style.fontWeight = "bold";
                nameSpan.appendChild(marker);
            }

            const nameText = document.createTextNode(c.ac);
            nameSpan.appendChild(nameText);

            const textP = document.createElement("p");
            textP.className = "comment-text";
            textP.textContent = c.cm;
            textP.style.margin = "0";
            textP.style.textAlign = "left";

            wrapperDiv.appendChild(nameSpan);
            wrapperDiv.appendChild(textP);

            div.appendChild(img);
            div.appendChild(wrapperDiv);

            // „Ç≥„É°„É≥„Éà„Çí„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´
            div.style.cursor = "pointer";
            div.onclick = () => {
                showCommentHistory(c.u, c.ac, c.av);
            };

            // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†
            if (!commentHistory[c.u]) {
                commentHistory[c.u] = [];
            }
            commentHistory[c.u].unshift({
                time: c.created_at ? new Date(c.created_at * 1000) : new Date(),
                name: c.ac,
                text: c.cm,
                avatar: c.av
            });
            // ÊúÄÂ§ß100‰ª∂„Åæ„Åß‰øùÊåÅ
            if (commentHistory[c.u].length > 100) {
                commentHistory[c.u].pop();
            }

            // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
            const commentModal = document.getElementById("commentHistoryModal");
            if (commentModal.classList.contains("show")) {
                const currentUserId = commentModal.getAttribute("data-user-id");
                if (currentUserId == c.u) {
                    showCommentHistory(c.u, c.ac, c.av);
                }
            }

            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÁî®„Å´„Ç≥„É°„É≥„Éà„ÇíË®òÈå≤
            const commentHash = `${c.u}_${c.cm}_${c.created_at || Date.now()}`;
            receivedComments.add(commentHash);

            document.getElementById("comment").prepend(div);
        }

        // t18„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊõ¥Êñ∞
        function updateT18ModalContent() {
            const contentDiv = document.getElementById("t18ModalContent");
            contentDiv.innerHTML = "";

            if (t18MessageHistory.length === 0) {
                contentDiv.innerHTML = "<div class='t18-no-messages'>„Åæ„Å†„Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>";
            } else {
                t18MessageHistory.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "t18-message-item";
                    itemDiv.style.borderLeftColor = item.color;

                    const timeDiv = document.createElement("div");
                    timeDiv.className = "t18-message-time";
                    timeDiv.textContent = item.time.toLocaleString();

                    const textDiv = document.createElement("div");
                    textDiv.className = "t18-message-text";
                    textDiv.style.color = item.color;
                    textDiv.textContent = item.message;

                    itemDiv.appendChild(timeDiv);
                    itemDiv.appendChild(textDiv);
                    contentDiv.appendChild(itemDiv);
                });
            }
        }

        // t18„É°„ÉÉ„Çª„Éº„Ç∏„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showT18Modal() {
            const modal = document.getElementById("t18Modal");

            // ‰ΩçÁΩÆ„ÇíÂàùÊúüÂåñ(‰∏≠Â§Æ)
            modal.style.left = "50%";
            modal.style.top = "50%";
            modal.style.transform = "translate(-50%, -50%)";

            // „Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇÇ„É™„Çª„ÉÉ„Éà
            if (typeof resetT18ModalPosition === 'function') {
                resetT18ModalPosition();
            }

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊõ¥Êñ∞
            updateT18ModalContent();

            modal.classList.add("show");
            // overlay„ÅØË°®Á§∫„Åó„Å™„ÅÑ
        }

        // t18„É¢„Éº„ÉÄ„É´„ÅÆ„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
        let resetT18ModalPosition; // ‰ΩçÁΩÆ„É™„Çª„ÉÉ„ÉàÈñ¢Êï∞„ÇíÂ§ñÈÉ®„Åã„ÇâÂëº„Å≥Âá∫„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã
        (function () {
            const modal = document.getElementById("t18Modal");
            const header = modal.querySelector(".t18-modal-header");
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;

            // ‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞„ÇíÂÖ¨Èñã
            resetT18ModalPosition = function () {
                currentX = 0;
                currentY = 0;
                initialX = 0;
                initialY = 0;
            };

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            function dragStart(e) {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØ„Éâ„É©„ÉÉ„Ç∞„Åó„Å™„ÅÑ
                if (e.target.classList.contains("t18-modal-close")) {
                    return;
                }

                isDragging = true;
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    modal.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
            }
        })();

        // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫
        function showCommentHistory(userId, userName, avatarId) {
            const modal = document.getElementById("commentHistoryModal");
            const userSpan = document.getElementById("commentHistoryUser");
            const listDiv = document.getElementById("commentHistoryList");

            // ‰ΩçÁΩÆ„ÇíÂàùÊúüÂåñ(‰∏≠Â§Æ)
            modal.style.left = "50%";
            modal.style.top = "50%";
            modal.style.transform = "translate(-50%, -50%)";

            // „Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇÇ„É™„Çª„ÉÉ„Éà
            modal.dataset.x = 0;
            modal.dataset.y = 0;
            // „Éâ„É©„ÉÉ„Ç∞ÂÜÖÈÉ®Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
            window.dispatchEvent(new CustomEvent('resetDragState'));

            // „Ç¢„Éê„Çø„Éº‰ªò„Åç„Åß„É¶„Éº„Ç∂„ÉºÂêç„ÇíË°®Á§∫
            if (avatarId) {
                const avatarImg = `<img src="https://image.showroom-cdn.com/showroom-prod/image/avatar/${avatarId}.png" style="width:30px; height:30px; vertical-align:middle; margin-right:8px; border-radius:50%;">`;
                userSpan.innerHTML = avatarImg + userName;
            } else {
                userSpan.textContent = userName;
            }

            listDiv.innerHTML = "";

            // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºID„Çí‰øùÂ≠ò
            modal.setAttribute("data-user-id", userId);

            const history = commentHistory[userId] || [];
            if (history.length === 0) {
                listDiv.innerHTML = "<p style='text-align:center; color:#999;'>„Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>";
            } else {
                history.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "history-item";

                    const timeDiv = document.createElement("div");
                    timeDiv.className = "history-time";
                    timeDiv.textContent = item.time.toLocaleTimeString();

                    const textDiv = document.createElement("div");
                    textDiv.className = "history-text";
                    textDiv.textContent = item.text;

                    itemDiv.appendChild(timeDiv);
                    itemDiv.appendChild(textDiv);
                    listDiv.appendChild(itemDiv);
                });
            }

            modal.classList.add("show");
            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅØË°®Á§∫„Åó„Å™„ÅÑ
        }

        // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.getElementById("closeCommentHistory").onclick = () => {
            document.getElementById("commentHistoryModal").classList.remove("show");
            // ‰ªñ„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇÇÈñâ„Åò„Çã
            if (document.getElementById("alarmModal").style.display !== "block" &&
                document.getElementById("notificationModal").style.display !== "block") {
                document.getElementById("overlay").style.display = "none";
            }
        };

        // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫
        function showGiftHistory(userId, userName) {
            const modal = document.getElementById("giftHistoryModal");
            const userSpan = document.getElementById("giftHistoryUser");
            const listDiv = document.getElementById("giftHistoryList");



            // ‰ΩçÁΩÆ„ÇíÂàùÊúüÂåñ(‰∏≠Â§Æ)
            modal.style.left = "50%";
            modal.style.top = "50%";
            modal.style.transform = "translate(-50%, -50%)";

            // „Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇÇ„É™„Çª„ÉÉ„Éà
            modal.dataset.x = 0;
            modal.dataset.y = 0;
            // „Éâ„É©„ÉÉ„Ç∞ÂÜÖÈÉ®Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
            window.dispatchEvent(new CustomEvent('resetDragState'));

            userSpan.textContent = userName;
            listDiv.innerHTML = "";

            const history = giftHistory[userId] || [];
            if (history.length === 0) {
                listDiv.innerHTML = "<p style='text-align:center; color:#999;'>„ÇÆ„Éï„ÉàÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>";
            } else {
                let totalPoints = 0;

                history.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "gift-history-item";

                    const timeDiv = document.createElement("div");
                    timeDiv.className = "gift-history-time";
                    timeDiv.textContent = item.time.toLocaleTimeString();

                    const giftDiv = document.createElement("div");
                    giftDiv.className = "gift-history-gift";

                    const giftImg = document.createElement("img");
                    giftImg.src = `https://static.showroom-live.com/image/gift/${item.giftId}_s.png?v=7`;

                    const giftNameSpan = document.createElement("span");
                    giftNameSpan.className = "gift-history-gift-name";
                    giftNameSpan.textContent = item.giftName;

                    const countSpan = document.createElement("span");
                    countSpan.className = "gift-history-count";
                    countSpan.textContent = `√ó${item.count}`;

                    // „Éù„Ç§„É≥„ÉàË®àÁÆó
                    const giftInfo = giftMasterData[item.giftId];
                    if (giftInfo) {
                        const points = calculateGiftPoints(item.giftId, item.count, giftInfo.free, giftInfo.point);
                        totalPoints += points;

                        // „ÇÆ„Éï„ÉàÁîªÂÉè„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíË®≠ÂÆöÔºàÂêçÂâç„Å®Âçò‰Ωì„Éù„Ç§„É≥„ÉàÔºâ
                        const unit = giftInfo.free ? "pt" : "G";
                        giftImg.title = `${giftInfo.name}\n${giftInfo.point}${unit}`;

                        // Ë®àÁÆó„Åï„Çå„Åü„Éù„Ç§„É≥„Éà„ÇíË°®Á§∫
                        const pointSpan = document.createElement("span");
                        pointSpan.style.color = "#666";
                        pointSpan.style.marginLeft = "5px";
                        pointSpan.textContent = `(${Math.floor(points).toLocaleString()}pt)`;
                        countSpan.appendChild(pointSpan);
                    }

                    giftDiv.appendChild(giftImg);
                    giftDiv.appendChild(giftNameSpan);
                    giftDiv.appendChild(countSpan);

                    itemDiv.appendChild(timeDiv);
                    itemDiv.appendChild(giftDiv);
                    listDiv.appendChild(itemDiv);
                });

                // ÂêàË®à„Éù„Ç§„É≥„ÉàË°®Á§∫
                const totalDiv = document.createElement("div");
                totalDiv.style.marginTop = "15px";
                totalDiv.style.padding = "10px";
                totalDiv.style.borderTop = "2px solid #4CAF50";
                totalDiv.style.textAlign = "right";
                totalDiv.style.fontWeight = "bold";
                totalDiv.style.fontSize = "1.1em";
                totalDiv.textContent = `ÂêàË®à: ${Math.floor(totalPoints).toLocaleString()}pt`;
                listDiv.appendChild(totalDiv);
            }

            modal.classList.add("show");
            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅØË°®Á§∫„Åó„Å™„ÅÑ
        }

        // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.getElementById("closeGiftHistory").onclick = () => {
            document.getElementById("giftHistoryModal").classList.remove("show");
            // ‰ªñ„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇÇÈñâ„Åò„Çã
            if (document.getElementById("alarmModal").style.display !== "block" &&
                document.getElementById("notificationModal").style.display !== "block" &&
                !document.getElementById("commentHistoryModal").classList.contains("show")) {
                document.getElementById("overlay").style.display = "none";
            }
        };

        // „Ç≥„É°„É≥„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
        (function () {
            const modal = document.getElementById("commentHistoryModal");
            const header = modal.querySelector("h3");
            let isDragging = false;
            let initialX = 0;
            let initialY = 0;

            header.style.cursor = "move";

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà„Ç§„Éô„É≥„Éà„Çí„É™„ÉÉ„Çπ„É≥
            window.addEventListener('resetDragState', () => {
                isDragging = false;
                initialX = 0;
                initialY = 0;
            });

            function dragStart(e) {
                if (e.target.id === "closeCommentHistory" || e.target.closest("#closeCommentHistory")) {
                    return;
                }

                isDragging = true;
                // ÁèæÂú®„ÅÆÁßªÂãïÈáè„ÇíÂèñÂæó
                const currentX = parseFloat(modal.dataset.x || 0);
                const currentY = parseFloat(modal.dataset.y || 0);

                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    const currentX = e.clientX - initialX;
                    const currentY = e.clientY - initialY;

                    // ÁßªÂãïÈáè„Çí‰øùÂ≠ò
                    modal.dataset.x = currentX;
                    modal.dataset.y = currentY;

                    modal.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
            }
        })();

        // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
        (function () {
            const modal = document.getElementById("giftHistoryModal");
            const header = modal.querySelector("h3");
            let isDragging = false;
            let initialX = 0;
            let initialY = 0;

            header.style.cursor = "move";

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà„Ç§„Éô„É≥„Éà„Çí„É™„ÉÉ„Çπ„É≥
            window.addEventListener('resetDragState', () => {
                isDragging = false;
                initialX = 0;
                initialY = 0;
            });

            function dragStart(e) {
                if (e.target.id === "closeGiftHistory" || e.target.closest("#closeGiftHistory")) {
                    return;
                }

                isDragging = true;
                // ÁèæÂú®„ÅÆÁßªÂãïÈáè„ÇíÂèñÂæó
                const currentX = parseFloat(modal.dataset.x || 0);
                const currentY = parseFloat(modal.dataset.y || 0);

                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    const currentX = e.clientX - initialX;
                    const currentY = e.clientY - initialY;

                    // ÁßªÂãïÈáè„Çí‰øùÂ≠ò
                    modal.dataset.x = currentX;
                    modal.dataset.y = currentY;

                    modal.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
            }
        })();


        // Ë®≠ÂÆö„Éë„Éç„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
        (function () {
            const modal = document.getElementById("settingsPanel");
            const header = document.getElementById("settingsHeader");

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            function dragStart(e) {
                if (e.target.id === "closeSettings" || e.target.closest("#closeSettings")) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modal);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(calc(-50% + ${xPos}px), calc(-50% + ${yPos}px))`;
            }
        })();
        (function () {
            const modal = document.getElementById("giftHistoryModal");
            const header = modal.querySelector("h3");
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.style.cursor = "move";

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            function dragStart(e) {
                if (e.target.id === "closeGiftHistory" || e.target.closest("#closeGiftHistory")) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modal);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(calc(-50% + ${xPos}px), calc(-50% + ${yPos}px))`;
            }
        })();



        // „ÇÆ„Éï„ÉàË°®Á§∫ÔºàÁ¥ØÁ©çÔºâ
        function showGift(g) {
            const gt = parseInt(g.gt);
            let containerId, giftMap;

            // ÁÑ°Êñô„ÇÆ„Éï„ÉàÔºàgt===2Ôºâ
            if (gt === 2) {
                if (g.g === 3000421 || g.g === 3000421) {
                    // ÊòüÔºàID:3000421, 3000421Ôºâ
                    containerId = "freeStar";
                    giftMap = freeStarMap;
                } else {
                    // „Åù„ÅÆ‰ªñÁÑ°Êñô„ÇÆ„Éï„Éà
                    containerId = "freeOther";
                    giftMap = freeOtherMap;
                }
            }
            // ÊúâÊñô„ÇÆ„Éï„ÉàÔºàgt!==2Ôºâ
            else {
                containerId = "paidGift";
                giftMap = paidGiftMap;
            }


            const key = `${g.u}_${g.g}`;

            if (giftMap[key]) {
                const item = giftMap[key];
                item.count += g.n;
                item.time = Date.now();

                // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†ÔºàÊõ¥Êñ∞ÊôÇ„ÇÇÔºâ
                const giftInfo = giftMasterData[g.g];
                const giftType = gt === 2 ? (g.g === 3000421 ? 'freeStar' : 'freeOther') : 'paid';
                if (!giftHistory[g.u]) {
                    giftHistory[g.u] = [];
                }
                giftHistory[g.u].unshift({
                    time: g.created_at ? new Date(g.created_at * 1000) : new Date(),
                    name: g.ac,
                    giftId: g.g,
                    giftName: giftInfo ? giftInfo.name : `„ÇÆ„Éï„ÉàID:${g.g}`,
                    count: g.n,
                    type: giftType
                });
                if (giftHistory[g.u].length > 100) {
                    giftHistory[g.u].pop();
                }

                // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
                const giftModal = document.getElementById("giftHistoryModal");
                if (giftModal.classList.contains("show")) {
                    const currentUserId = giftModal.getAttribute("data-user-id");
                    if (currentUserId == g.u) {
                        showGiftHistory(g.u, g.ac);
                    }
                }

                // Ë°®Á§∫Êõ¥Êñ∞ÔºàÂÖ®„ÇÆ„Éï„ÉàÂÖ±ÈÄö„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
                const nameSpan = item.div.querySelector(".gift-name");
                const textP = item.div.querySelector(".gift-text");
                if (nameSpan) nameSpan.textContent = g.ac;
                if (textP) {
                    // „ÇÆ„Éï„ÉàÁîªÂÉè„Å®ÂÄãÊï∞„ÇíÊõ¥Êñ∞
                    const giftImg = textP.querySelector("img");
                    if (giftImg) {
                        giftImg.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
                        // Êõ¥Êñ∞ÊôÇ„ÇÇ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíË®≠ÂÆö
                        if (giftMasterData[g.g]) {
                            const info = giftMasterData[g.g];
                            const unit = info.free ? "pt" : "G";
                            giftImg.title = `${info.name}\n${info.point}${unit}`;
                        }
                    }
                    const countSpan = textP.querySelector(".gift-count");
                    if (countSpan) {
                        countSpan.textContent = `${item.count}ÂÄã`;
                    }
                }

                // È´òÈ°ç„ÇÆ„Éï„Éà„ÉÅ„Çß„ÉÉ„ÇØÔºà1Âõû„ÅÆÊäïÁ®øÂÄãÊï∞„ÅßË®àÁÆóÔºâ
                checkAndDisplayHighValueGift(g.u, g.ac, g.av, g.g, g.n);

                // ÊúÄÊñ∞Ë°å„Å®„Åó„Å¶„Éà„ÉÉ„Éó„Å´ÁßªÂãï
                item.div.remove();
                document.getElementById(containerId).prepend(item.div);

                return;

            }

            const div = document.createElement("div");
            div.className = "giftItem";

            // „ÇÆ„Éï„ÉàÊû†ÂÖ®‰Ωì„Çí„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´
            div.style.cursor = "pointer";
            div.onclick = () => {
                showGiftHistory(g.u, g.ac);
            };

            // ÂÖ®„ÇÆ„Éï„ÉàÂÖ±ÈÄö„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà
            const img1 = document.createElement("img");
            img1.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;

            // „ÇÆ„Éï„ÉàÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å´‰æ°Ê†º„ÇíË°®Á§∫
            const giftInfo = giftMasterData[g.g];
            if (giftInfo) {
                // img1.title = `${giftInfo.name}: ${giftInfo.point}pt`; // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„Åß„ÅØ„Å™„Åè„ÇÆ„Éï„ÉàÁîªÂÉè„Å´„Å§„Åë„Çã„Åπ„Åç„ÅãÔºü
                // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÅØ„ÄåÊúâÊñô„ÇÆ„Éï„Éà„ÅÆ„Éû„Ç¶„Çπ„Ç™„Éº„Éê„Éº„Åó„ÅüÈöõ„Å´„Äç„Å™„ÅÆ„Åß„ÄÅ„ÇÆ„Éï„ÉàÁîªÂÉè„Å´„Å§„Åë„Çã„ÅÆ„ÅåÈÅ©Âàá
            }

            // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†
            const giftType = gt === 2 ? (g.g === 3000421 ? 'freeStar' : 'freeOther') : 'paid';
            if (!giftHistory[g.u]) {
                giftHistory[g.u] = [];
            }
            giftHistory[g.u].unshift({
                time: g.created_at ? new Date(g.created_at * 1000) : new Date(),
                name: g.ac,
                giftId: g.g,
                giftName: giftInfo ? giftInfo.name : `„ÇÆ„Éï„ÉàID:${g.g}`,
                count: g.n,
                type: giftType
            });
            // ÊúÄÂ§ß100‰ª∂„Åæ„Åß‰øùÊåÅ
            if (giftHistory[g.u].length > 100) {
                giftHistory[g.u].pop();
            }

            // „ÇÆ„Éï„ÉàÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
            const giftModal = document.getElementById("giftHistoryModal");
            if (giftModal.classList.contains("show")) {
                const currentUserId = giftModal.getAttribute("data-user-id");
                if (currentUserId == g.u) {
                    showGiftHistory(g.u, g.ac);
                }
            }

            const contentDiv = document.createElement("div");
            contentDiv.className = "gift-content";

            const nameSpan = document.createElement("span");
            nameSpan.className = "gift-name";
            nameSpan.textContent = g.ac;

            const textP = document.createElement("p");
            textP.className = "gift-text";

            const giftImg = document.createElement("img");
            giftImg.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;

            // „ÇÆ„Éï„ÉàÁîªÂÉè„Å´‰æ°Ê†ºÊÉÖÂ†±„Çí„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å®„Åó„Å¶Ë®≠ÂÆö
            if (giftMasterData[g.g]) {
                const info = giftMasterData[g.g];
                const ptLabel = info.free ? "" : "G"; // ÁÑ°Êñô„Å™„ÇâÂçò‰Ωç„Å™„Åó„Åãpt„Åã„ÄÅÊúâÊñô„Å™„ÇâG„Åã„ÄÇAPI„ÅØpoint„ÄÇ
                // Showroom„ÅØÊúâÊñô„ÇÆ„Éï„Éà„ÅØGold(G)„ÄÅÁÑ°Êñô„ÅØPoint(pt)„Å†„Åå„ÄÅAPI„ÅÆpoint„Éï„Ç£„Éº„É´„Éâ„ÅØÂÖ±ÈÄö„ÄÇ
                // „Çè„Åã„Çä„ÇÑ„Åô„Åè "100pt" „ÇÑ "100G" „Å®„Åô„Çã„Åã„ÄÅÂçò„Å´ "100" „Å®„Åô„Çã„Åã„ÄÇ
                // Ë¶ÅÊúõ„ÅØ„ÄåÈáëÈ°ç„ÇíË¶ã„Çå„Çã„Çà„ÅÜ„Å´„Äç„Å™„ÅÆ„Åß„ÄÅÂçò‰Ωç„Çí„Å§„Åë„Çã„ÄÇ
                const unit = info.free ? "pt" : "G";
                giftImg.title = `${info.name}\n${info.point}${unit}`;
            }

            const multiplySpan = document.createElement("span");
            multiplySpan.textContent = "√ó";

            const countSpan = document.createElement("span");
            countSpan.className = "gift-count";
            countSpan.textContent = `${g.n}ÂÄã`;

            textP.appendChild(giftImg);
            textP.appendChild(multiplySpan);
            textP.appendChild(countSpan);

            contentDiv.appendChild(nameSpan);
            contentDiv.appendChild(textP);

            div.appendChild(img1);
            div.appendChild(contentDiv);

            document.getElementById(containerId).prepend(div);

            giftMap[key] = { div: div, count: g.n, time: Date.now() };

            // È´òÈ°ç„ÇÆ„Éï„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            checkAndDisplayHighValueGift(g.u, g.ac, g.av, g.g, g.n);
        }

        // „ÇÆ„Éï„Éà„Éù„Ç§„É≥„ÉàË®àÁÆóÈñ¢Êï∞
        function calculateGiftPoints(giftId, count, isFree, basePoint) {
            // ÂÄãÊï∞„Å´„Çà„ÇãÂÄçÁéá„ÉÜ„Éº„Éñ„É´
            const quantityMultipliers = {
                1: 1.00,
                2: 1.04,
                3: 1.06,
                4: 1.08,
                5: 1.10,
                6: 1.12,
                7: 1.14,
                8: 1.16,
                9: 1.18,
                10: 1.20
            };

            // ÂÄãÊï∞ÂÄçÁéá„ÇíÂèñÂæóÔºà10ÂÄãË∂Ö„Åà„ÇãÂ†¥Âêà„ÅØ1.2ÂÄçÂõ∫ÂÆöÔºâ
            const quantityMultiplier = count <= 10 ? quantityMultipliers[count] : 1.20;

            let totalPoints = 0;

            if (isFree) {
                // ÁÑ°Êñô„ÇÆ„Éï„Éà„ÅÆË®àÁÆó
                const isStar = (giftId === 3000421 || giftId === 800094);

                if (isStar) {
                    // ÁÑ°Êñô„ÇÆ„Éï„Éà‚òÜ: Âü∫Êú¨„Éù„Ç§„É≥„Éà √ó ÂÄãÊï∞ √ó ÂÄçÁéá
                    totalPoints = basePoint * count * quantityMultiplier;
                } else {
                    // ÁÑ°Êñô„ÇÆ„Éï„ÉàÔºà„Åù„ÅÆ‰ªñÔºâ: Âü∫Êú¨„Éù„Ç§„É≥„Éà √ó ÂÄãÊï∞ √ó ÂÄçÁéá
                    totalPoints = basePoint * count * quantityMultiplier;

                    // „ÇÆ„Éï„ÉàID 1601 „ÅØËøΩÂä†„Åß2.5ÂÄç
                    if (giftId === 1601) {
                        totalPoints *= 2.5;
                    }
                }
            } else {
                // ÊúâÊñô„ÇÆ„Éï„Éà„ÅÆË®àÁÆó
                // Âü∫Êú¨G √ó 2.5 √ó ÂÄãÊï∞ √ó ÂÄçÁéá
                totalPoints = basePoint * 2.5 * count * quantityMultiplier;

                // 500G‰ª•‰∏ä„ÅÆ„ÇÆ„Éï„Éà„ÅØ√ó1ÔΩû√ó10ÂÄã„Åô„Åπ„Å¶1.2ÂÄçË®àÁÆó
                if (basePoint >= 500 && count <= 10) {
                    totalPoints = basePoint * 2.5 * count * 1.20;
                }
            }

            return Math.floor(totalPoints);
        }

        // È´òÈ°ç„ÇÆ„Éï„ÉàË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ„Å®Êõ¥Êñ∞
        function checkAndDisplayHighValueGift(userId, userName, avatarId, giftId, count) {
            // „ÇÆ„Éï„ÉàÊÉÖÂ†±„ÇíÂèñÂæóÔºà„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà‰ΩúÊàêÔºâ
            let giftInfo = giftMasterData[giftId];
            if (!giftInfo) {
                giftInfo = {
                    name: `Unknown Gift (${giftId})`,
                    free: true,
                    point: 1
                };
            }

            // 1Âõû„ÅÆÊäïÁ®ø„ÅÆ„Éù„Ç§„É≥„ÉàË®àÁÆó
            const pointsThisGift = calculateGiftPoints(giftId, count, giftInfo.free, giftInfo.point);

            // „É¶„Éº„Ç∂„Éº„Åî„Å®„ÅÆÈõÜË®à„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ
            if (!userHighValueData[userId]) {
                userHighValueData[userId] = {
                    totalPoints: 0,
                    totalCount: 0, // ÂÖ®„ÇÆ„Éï„Éà„ÅÆÂêàË®àÂÄãÊï∞
                    bestGift: { id: 0, point: -1, name: "" },
                    gifts: {} // giftId: { count: 0, points: 0, info: ... }
                };
            }

            const userData = userHighValueData[userId];
            userData.totalPoints += pointsThisGift;
            userData.totalCount += count;

            // „ÇÆ„Éï„Éà„Åî„Å®„ÅÆÈõÜË®à
            if (!userData.gifts[giftId]) {
                userData.gifts[giftId] = {
                    count: 0,
                    points: 0,
                    info: giftInfo
                };
            }
            userData.gifts[giftId].count += count;
            userData.gifts[giftId].points += pointsThisGift;

            // ÊúÄÈ´òÂçò‰æ°„ÇÆ„Éï„Éà„ÅÆÊõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
            // Êó¢Â≠ò„ÅÆbestGift„Çà„ÇäÂçò‰æ°„ÅåÈ´ò„ÅÑ„ÄÅ„Åæ„Åü„ÅØÂêå„Åò„ÅßÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà
            if (giftInfo.point > userData.bestGift.point) {
                userData.bestGift = {
                    id: giftId,
                    point: giftInfo.point,
                    name: giftInfo.name,
                    free: giftInfo.free
                };
            }

            // Ë°®Á§∫ÈñæÂÄ§„ÉÅ„Çß„ÉÉ„ÇØ (10000pt‰ª•‰∏ä)
            if (userData.totalPoints >= 10000) {
                updateHighValueDisplay(userId, userName, avatarId, userData);
            }
        }

        function updateHighValueDisplay(userId, userName, avatarId, userData) {
            const container = document.getElementById("highValueGiftContainer");
            const itemId = `high-value-${userId}`;
            let itemDiv = document.getElementById(itemId);

            // Ë°®Á§∫ÂÜÖÂÆπ„ÅÆÊßãÁØâ
            const bestGiftId = userData.bestGift.id;
            const totalPoints = userData.totalPoints;

            // Êû†„ÅÆËâ≤Âà§ÂÆö
            let borderClass = "silver";
            if (totalPoints >= 30000) {
                borderClass = "gold";
            }

            if (itemDiv) {
                // Êó¢Â≠òÊõ¥Êñ∞
                itemDiv.className = `high-value-gift-item ${borderClass}`;

                // ÁîªÂÉèÊõ¥Êñ∞ÔºàÊúÄÈ´òÂçò‰æ°„ÇÆ„Éï„Éà„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„Å™„Å©Ôºâ
                const giftImg = itemDiv.querySelector("img.gift");
                if (giftImg.src.indexOf(`${bestGiftId}_s.png`) === -1) {
                    giftImg.src = `https://static.showroom-live.com/image/gift/${bestGiftId}_s.png?v=7`;
                    giftImg.title = userData.bestGift.name;
                }

                // „Éù„Ç§„É≥„ÉàÊõ¥Êñ∞
                const countSpan = itemDiv.querySelector(".count");
                countSpan.textContent = `${Math.floor(totalPoints).toLocaleString()}pt`;

                // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„Å´„Ç∏„É£„É≥„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®
                const avatarImg = itemDiv.querySelector("img.avatar");
                if (avatarImg) {
                    // Êó¢Â≠ò„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇØ„É©„Çπ„ÇíÂâäÈô§
                    avatarImg.classList.remove("jump");
                    // „É™„Éï„É≠„Éº„ÇíÂº∑Âà∂„Åó„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà
                    void avatarImg.offsetWidth;
                    // „Ç∏„É£„É≥„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
                    avatarImg.classList.add("jump");

                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´„ÇØ„É©„Çπ„ÇíÂâäÈô§ÔºàÂÜçÂà©Áî®ÂèØËÉΩ„Å´„Åô„ÇãÔºâ
                    setTimeout(() => {
                        avatarImg.classList.remove("jump");
                    }, 500); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì„Å®Âêå„Åò
                }

                // ‰ΩçÁΩÆ„ÅØsortHighValueItems()„ÅßÊ±∫ÂÆö„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÁßªÂãï„Åó„Å™„ÅÑ

            } else {
                // Êñ∞Ë¶è‰ΩúÊàê
                itemDiv = document.createElement("div");
                itemDiv.id = itemId;
                itemDiv.className = `high-value-gift-item ${borderClass}`;

                const avatarImg = document.createElement("img");
                avatarImg.className = "avatar";
                avatarImg.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${avatarId}.png`;
                avatarImg.title = userName;

                const giftImg = document.createElement("img");
                giftImg.className = "gift";
                giftImg.src = `https://static.showroom-live.com/image/gift/${bestGiftId}_s.png?v=7`;
                giftImg.title = userData.bestGift.name;

                const topDiv = document.createElement("div");
                topDiv.className = "high-value-gift-top";
                topDiv.appendChild(avatarImg);
                topDiv.appendChild(giftImg);

                const countSpan = document.createElement("span");
                countSpan.className = "count";
                countSpan.textContent = `${Math.floor(totalPoints).toLocaleString()}pt`;

                itemDiv.appendChild(topDiv);
                itemDiv.appendChild(countSpan);

                // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                itemDiv.style.cursor = "pointer";
                itemDiv.onclick = (e) => {
                    showHighValuePopup(e, userId, userName, avatarId, userData);
                };

                container.appendChild(itemDiv);
            }

            // „Éù„Ç§„É≥„ÉàÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ
            sortHighValueItems();
        }

        // „Éù„Ç§„É≥„ÉàÈ†Ü„Å´„ÇΩ„Éº„Éà„Åó„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function sortHighValueItems() {
            const container = document.getElementById("highValueGiftContainer");
            if (!container) return;

            const items = Array.from(container.children);
            if (items.length <= 1) return; // 1„Å§‰ª•‰∏ã„Å™„Çâ„ÇΩ„Éº„Éà‰∏çË¶Å

            // ÁèæÂú®„ÅÆ‰ΩçÁΩÆÔºà„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºâ„Å®ÁîªÈù¢‰∏ä„ÅÆ‰ΩçÁΩÆ„ÇíË®òÈå≤
            const oldPositions = new Map();
            const oldScreenPositions = new Map();
            items.forEach((item, index) => {
                const userId = item.id.replace('high-value-', '');
                oldPositions.set(userId, index);
                // ÁîªÈù¢‰∏ä„ÅÆÂÆüÈöõ„ÅÆ‰ΩçÁΩÆ„ÇíË®òÈå≤
                const rect = item.getBoundingClientRect();
                oldScreenPositions.set(userId, { left: rect.left, top: rect.top });
            });

            // „Éù„Ç§„É≥„ÉàÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÈôçÈ†ÜÔºâ
            items.sort((a, b) => {
                const userIdA = a.id.replace('high-value-', '');
                const userIdB = b.id.replace('high-value-', '');
                const pointsA = userHighValueData[userIdA]?.totalPoints || 0;
                const pointsB = userHighValueData[userIdB]?.totalPoints || 0;
                return pointsB - pointsA; // ÈôçÈ†Ü
            });

            // DOMÂÜçÈÖçÁΩÆÔºà„ÇΩ„Éº„ÉàÈ†Ü„Å´Ôºâ
            items.forEach(item => container.appendChild(item));

            // „É™„Éï„É≠„Éº„ÇíÂº∑Âà∂
            void container.offsetHeight;

            // ‰ΩçÁΩÆÂ§âÊõ¥„ÇíÊ§úÂá∫„Åó„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            items.forEach((item, newIndex) => {
                const userId = item.id.replace('high-value-', '');
                const oldIndex = oldPositions.get(userId);

                if (oldIndex !== undefined && oldIndex !== newIndex) {
                    const oldPos = oldScreenPositions.get(userId);
                    const newRect = item.getBoundingClientRect();

                    // ÂÆüÈöõ„ÅÆÁîªÈù¢‰∏ä„ÅÆÁßªÂãïË∑ùÈõ¢ÔºàOld - NewÔºâ
                    // Jumper (Left/Up): Positive
                    // Overtaken (Right/Down): Negative
                    const moveDistance = oldPos.left - newRect.left;

                    if (newIndex < oldIndex) {
                        // Jumper (È†Ü‰Ωç‰∏äÊòá) -> ÊîæÁâ©Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                        // CSSÂ§âÊï∞„Å´ÁßªÂãïË∑ùÈõ¢„ÇíË®≠ÂÆö
                        item.style.setProperty('--move-distance', `${moveDistance}px`);
                        item.classList.remove('moving');
                        void item.offsetWidth; // „É™„Éï„É≠„Éº
                        item.classList.add('moving');

                        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´„ÇØ„É©„Çπ„Å®„Çπ„Çø„Ç§„É´„ÇíÂâäÈô§
                        setTimeout(() => {
                            item.classList.remove('moving');
                            item.style.removeProperty('--move-distance');
                        }, 800);
                    } else {
                        // Overtaken (È†Ü‰Ωç‰∏ãÈôç) -> „Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ (FLIP)
                        // 1. „Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥„Å™„Åó„ÅßÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å´ÁßªÂãï
                        item.style.transition = 'none';
                        item.style.transform = `translateX(${moveDistance}px)`;

                        // 2. „É™„Éï„É≠„Éº
                        void item.offsetWidth;

                        // 3. „Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ÊúâÂäπÂåñ„Åó„Å¶Êñ∞„Åó„ÅÑ‰ΩçÁΩÆÔºà0Ôºâ„Å∏ÁßªÂãï
                        item.style.transition = 'transform 0.8s cubic-bezier(0.45, 0, 0.55, 1)';
                        item.style.transform = 'translateX(0)';

                        // 4. „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                        setTimeout(() => {
                            item.style.transition = '';
                            item.style.transform = '';
                        }, 800);
                    }
                }
            });
        }

        function showHighValuePopup(e, userId, userName, avatarId, userData) {
            const popup = document.getElementById("highValuePopup");

            // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±
            document.getElementById("popupAvatar").src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${avatarId}.png`;
            document.getElementById("popupUserName").textContent = userName;

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢„ÅÆ„ÇØ„É™„Ç¢„Å®ÂÜçÊßãÁØâ
            const contentDiv = popup.querySelector(".high-value-popup-content");
            contentDiv.innerHTML = "";

            // Á¥ØË®à„Éù„Ç§„É≥„ÉàÔºà‰∏ÄÁï™‰∏äÔºâ
            const totalRow = document.createElement("div");
            totalRow.className = "high-value-popup-row";
            totalRow.style.borderBottom = "2px solid #eee";
            totalRow.style.marginBottom = "10px";
            totalRow.style.paddingBottom = "5px";

            const totalLabel = document.createElement("span");
            totalLabel.className = "high-value-popup-label";
            totalLabel.textContent = "Á¥ØË®à„Éù„Ç§„É≥„Éà:";

            const totalValue = document.createElement("span");
            totalValue.className = "high-value-popup-value";
            totalValue.style.fontSize = "1.2em";
            totalValue.style.color = "#d00";
            totalValue.textContent = `${Math.floor(userData.totalPoints).toLocaleString()}pt`;

            totalRow.appendChild(totalLabel);
            totalRow.appendChild(totalValue);
            contentDiv.appendChild(totalRow);

            // „ÇÆ„Éï„Éà‰∏ÄË¶ßÔºàÁ∏¶„Å´‰∏¶„Åπ„ÇãÔºâ
            // userData.gifts „Çí„É´„Éº„Éó
            Object.keys(userData.gifts).forEach(giftId => {
                const giftData = userData.gifts[giftId];

                const row = document.createElement("div");
                row.className = "high-value-popup-row";
                row.style.justifyContent = "flex-start"; // Â∑¶ÂØÑ„Åõ
                row.style.marginBottom = "5px";

                const img = document.createElement("img");
                img.src = `https://static.showroom-live.com/image/gift/${giftId}_s.png?v=7`;
                img.style.width = "30px";
                img.style.height = "30px";
                img.style.marginRight = "10px";

                // „ÇÆ„Éï„Éà‰æ°Ê†ºË°®Á§∫ÔºàÊúâÊñô„ÇÆ„Éï„Éà„ÅØG„ÄÅÁÑ°Êñô„ÇÆ„Éï„Éà„ÅØptÔºâ
                const priceText = document.createElement("span");
                priceText.style.fontSize = "0.9em";
                priceText.style.color = "#666";
                priceText.style.marginRight = "5px";
                const unit = giftData.info.free ? "pt" : "G";
                priceText.textContent = `(${giftData.info.point.toLocaleString()}${unit})`;

                const countText = document.createElement("span");
                countText.style.fontWeight = "bold";
                countText.textContent = `√ó ${giftData.count.toLocaleString()}`;

                const nameText = document.createElement("span");
                nameText.style.fontSize = "0.8em";
                nameText.style.color = "#666";
                nameText.style.marginLeft = "10px";
                nameText.textContent = `(${giftData.info.name})`;

                row.appendChild(img);
                row.appendChild(priceText);
                row.appendChild(countText);
                row.appendChild(nameText);

                contentDiv.appendChild(row);
            });

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫‰ΩçÁΩÆË®àÁÆó
            popup.classList.add("show");
            const popupRect = popup.getBoundingClientRect();

            let left = e.clientX + 10;
            let top = e.clientY + 10;

            if (left + popupRect.width > window.innerWidth) {
                left = e.clientX - popupRect.width - 10;
            }
            if (top + popupRect.height > window.innerHeight) {
                top = e.clientY - popupRect.height - 10;
            }
            if (left < 0) left = 10;
            if (top < 0) top = 10;

            popup.style.left = `${left}px`;
            popup.style.top = `${top}px`;
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function setStatus(status) {
            const span = document.getElementById("statusSpan");
            span.className = "";
            if (status === "connecting") { span.textContent = "Status: ÂÜçÊé•Á∂ö‰∏≠"; span.classList.add("connecting"); }
            else if (status === "connected") { span.textContent = "Status: Êé•Á∂ö‰∏≠"; span.classList.add("connected"); }
            else { span.textContent = "Status: ÂàáÊñ≠"; span.classList.add("disconnected"); }
        }

        // Êé•Á∂ö
        async function connectRoom(roomId) {
            if (!roomId) return;
            if (reconnectTimeout) clearTimeout(reconnectTimeout);

            // „É™„Çª„ÉÉ„Éà
            startedAt = null;
            document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
            document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";

            try {
                setStatus("connecting");

                // current_live_started_at ÂèñÂæó
                try {
                    const profileRes = await fetch(`/room_profile?room_id=${roomId}`);
                    const profileJson = await profileRes.json();
                    if (profileJson.current_live_started_at) {
                        startedAt = profileJson.current_live_started_at * 1000;
                        const startedAtDate = new Date(startedAt);
                        document.getElementById("currentLiveStartedAtSpan").textContent =
                            `ÈÖç‰ø°ÈñãÂßã: ${startedAtDate.toLocaleString()}`;
                    } else {
                        startedAt = null;
                        document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
                        document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
                    }

                    if (profileJson.room_name) {
                        document.getElementById("roomNameSpan").textContent = "Room: " + profileJson.room_name;
                    } else {
                        document.getElementById("roomNameSpan").textContent = "Room: -";
                    }
                } catch (e) {
                    console.warn("room_profileÂèñÂæóÂ§±Êïó:", e);
                    startedAt = null;
                    document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
                    document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
                }

                // „ÇÆ„Éï„Éà„É™„Çπ„ÉàÂèñÂæó
                try {
                    const giftRes = await fetch(`/gift_list?room_id=${roomId}`);
                    const giftJson = await giftRes.json();

                    // normal„Å®enquete„Çí„Éû„Éº„Ç∏„Åó„Å¶„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Çí‰ΩúÊàê
                    const processGifts = (list) => {
                        if (!list) return;
                        list.forEach(item => {
                            giftMasterData[item.gift_id] = {
                                name: item.gift_name,
                                point: item.point,
                                free: item.free
                            };
                        });
                    };

                    processGifts(giftJson.normal);
                    processGifts(giftJson.enquete);
                    console.log("Gift data loaded:", Object.keys(giftMasterData).length);

                } catch (e) {
                    console.warn("gift_listÂèñÂæóÂ§±Êïó:", e);
                }

                // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
                currentRoomId = roomId;
                startCommentLogPolling(roomId);

                const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
                const json = await res.json();
                if (!json.broadcast_key) { alert("broadcast_keyÂèñÂæóÂ§±Êïó"); return; }
                broadcastKey = json.broadcast_key;

                if (socket) socket.close();

                socket = new WebSocket("wss://online.showroom-live.com");
                socket.onopen = () => {
                    socket.send("SUB\t" + broadcastKey);
                    setStatus("connected");

                    // „Éè„Éº„Éà„Éì„Éº„ÉàÈñãÂßã
                    hbInterval = setInterval(() => {
                        if (socket && socket.readyState === WebSocket.OPEN) socket.send("PING");
                    }, 10000);
                };

                socket.onmessage = (msg) => {
                    // ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„ÅØ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá¶ÁêÜ„Åó„Å™„ÅÑ
                    if (isPaused) return;

                    const data = msg.data;
                    if (data.startsWith("ACK") || data.startsWith("ERR")) return;
                    const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`, ""));
                    if (obj.cm) showComment(obj);
                    else if (obj.g) showGift(obj);
                    else if (obj.t === 18 && obj.m) showComment(obj); // „Éï„Ç°„É≥„É¨„Éô„É´„Ç¢„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏
                    // current_live_started_at„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅWebSocket„Åã„Çâ„ÅÆstarted_at„Çí‰ΩøÁî®
                    if (!startedAt && obj.started_at) {
                        startedAt = obj.started_at * 1000;
                        const startedAtDate = new Date(startedAt);
                        document.getElementById("currentLiveStartedAtSpan").textContent =
                            `ÈÖç‰ø°ÈñãÂßã: ${startedAtDate.toLocaleString()}`;
                    }
                    if (obj.main_name) document.getElementById("roomNameSpan").textContent = "Room: " + obj.main_name;
                };

                socket.onclose = (event) => {
                    console.log("WebSocket closed:", event.code, event.reason);
                    setStatus("disconnected");
                    if (hbInterval) clearInterval(hbInterval);
                    // 5ÁßíÂæå„Å´Ëá™ÂãïÂÜçÊé•Á∂ö
                    reconnectTimeout = setTimeout(() => connectRoom(roomId), 5000);
                };

                socket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };


            } catch (e) {
                console.error(e);
                setStatus("disconnected");
                // 5ÁßíÂæå„Å´ÂÜçÊé•Á∂ö
                reconnectTimeout = setTimeout(() => connectRoom(roomId), 5000);
            }
        }




        // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
        function startCommentLogPolling(roomId) {
            // Êó¢Â≠ò„ÅÆ„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
            if (commentLogInterval) {
                clearInterval(commentLogInterval);
            }

            let isPolling = false;

            const poll = async () => {
                if (isPolling) return; // ÂâçÂõû„ÅÆÂá¶ÁêÜ„ÅåÁµÇ„Çè„Å£„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó
                if (isPaused) return; // ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„ÅØ„Éù„Éº„É™„É≥„Ç∞„Åó„Å™„ÅÑ
                isPolling = true;

                try {
                    const res = await fetch(`/comment_log?room_id=${roomId}`);
                    const json = await res.json();

                    if (json && json.comment_log && Array.isArray(json.comment_log)) {
                        // „Ç≥„É°„É≥„Éà„ÇíÂè§„ÅÑÈ†Ü„Å´Âá¶ÁêÜÔºàÊôÇÁ≥ªÂàóÈ†Ü„Å´Ë°®Á§∫„Åô„Çã„Åü„ÇÅÔºâ
                        const comments = json.comment_log.slice().reverse();

                        comments.forEach(comment => {
                            // Êäú„Åë„ÉÅ„Çß„ÉÉ„ÇØÂÜçË°®Á§∫ÈÉ®ÂàÜ„Åß„ÅØ user_id === 0 „ÇíÈô§Â§ñ
                            if (comment.user_id === 0) return;

                            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ: Âêå„É¶„Éº„Ç∂„ÉºID„ÄÅÂêå„Ç≥„É°„É≥„Éà„ÄÅ¬±5Áßí‰ª•ÂÜÖ„Åß„ÅÇ„Çå„Å∞ÈáçË§á„Å®„Åø„Å™„Åô
                            const isDuplicate = Array.from(receivedComments).some(hash => {
                                const firstUnderscore = hash.indexOf('_');
                                const lastUnderscore = hash.lastIndexOf('_');

                                if (firstUnderscore === -1 || lastUnderscore === -1 || firstUnderscore === lastUnderscore) {
                                    return false;
                                }

                                const storedUserId = hash.substring(0, firstUnderscore);
                                const storedTimestamp = hash.substring(lastUnderscore + 1);
                                const storedComment = hash.substring(firstUnderscore + 1, lastUnderscore);

                                if (storedUserId == comment.user_id && storedComment === comment.comment) {
                                    const timeDiff = Math.abs(parseInt(storedTimestamp) - comment.created_at);
                                    return timeDiff <= 5; // ¬±5Áßí‰ª•ÂÜÖ
                                }
                                return false;
                            });

                            if (!isDuplicate) {
                                const commentHash = `${comment.user_id}_${comment.comment}_${comment.created_at}`;
                                receivedComments.add(commentHash);

                                // „Ç≥„É°„É≥„Éà„ÇíË°®Á§∫ÔºàË£úÂÆå„Åï„Çå„Åü„Åì„Å®„ÇíÁ§∫„Åô„Éû„Éº„Ç´„Éº‰ªò„ÅçÔºâ
                                const commentObj = {
                                    u: comment.user_id,
                                    ac: comment.name,
                                    cm: comment.comment,
                                    av: comment.avatar_id, // „Ç¢„Éê„Çø„ÉºID„Çí„Éû„ÉÉ„Éî„É≥„Ç∞
                                    created_at: comment.created_at,
                                    fromPolling: true // „Éù„Éº„É™„É≥„Ç∞„Åã„Çâ„ÅÆ„Ç≥„É°„É≥„Éà„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åô„Éï„É©„Ç∞
                                };
                                showComment(commentObj);
                            }
                        });
                    }
                } catch (e) {
                    console.warn("comment_log„Éù„Éº„É™„É≥„Ç∞„Ç®„É©„Éº:", e);
                } finally {
                    isPolling = false;
                }
            };

            // ÂàùÂõûÂç≥ÊôÇÂÆüË°å
            poll();

            // 10Áßí„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞ÔºàÈñìÈöî„ÇíÂ∫É„Åí„Å¶Ë≤†Ëç∑ËªΩÊ∏õÔºâ
            commentLogInterval = setInterval(poll, 10000);
        }

        // ÁµåÈÅéÊôÇÈñìÊõ¥Êñ∞
        setInterval(() => {
            if (startedAt) {
                const now = Date.now();
                const diff = Math.floor((now - startedAt) / 1000);
                const h = Math.floor(diff / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                document.getElementById("currentLiveElapsedSpan").textContent = `ÁµåÈÅéÊôÇÈñì: ${h}ÊôÇÈñì ${m}ÂàÜ ${s}Áßí`;
            } else {
                document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
            }
        }, 1000);

        // „É´„Éº„É†ÂàáÊõø„Éú„Çø„É≥
        document.getElementById("switchRoom").onclick = () => {
            const newRoomId = document.getElementById("roomInput").value.trim();
            if (newRoomId) connectRoom(newRoomId);
        };

        // ÂàùÊúü„É´„Éº„É†
        connectRoom(490133);
        // „É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
        const resizer = document.getElementById("resizer");
        const bottomPanel = document.getElementById("highValueGiftContainer");
        const container = document.querySelector(".container");
        let isResizing = false;
        let startY = 0;
        let startHeight = 0;

        resizer.addEventListener("mousedown", (e) => {
            isResizing = true;
            startY = e.clientY;
            startHeight = parseInt(document.defaultView.getComputedStyle(bottomPanel).height, 10);
            document.body.style.cursor = "row-resize";
            document.body.style.userSelect = "none"; // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÈò≤Ê≠¢
        });

        document.addEventListener("mousemove", (e) => {
            if (!isResizing) return;
            const dy = startY - e.clientY; // ‰∏ä„Å´„Éâ„É©„ÉÉ„Ç∞„Åô„Çã„Å®È´ò„Åï„ÅåÂ¢ó„Åà„Çã
            const newHeight = startHeight + dy;

            // ÊúÄÂ∞è„ÉªÊúÄÂ§ßÈ´ò„Åï„ÅÆÂà∂Èôê
            if (newHeight > 50 && newHeight < window.innerHeight - 150) {
                bottomPanel.style.height = `${newHeight}px`;
            }
        });

        document.addEventListener("mouseup", () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }
        });

        // „Ç´„É©„É†„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
        document.querySelectorAll('.col-resizer').forEach(resizer => {
            resizer.addEventListener('mousedown', (e) => {
                let leftCol = resizer.previousElementSibling;
                while (leftCol && !leftCol.classList.contains('column')) {
                    leftCol = leftCol.previousElementSibling;
                }

                let rightCol = resizer.nextElementSibling;
                while (rightCol && !rightCol.classList.contains('column')) {
                    rightCol = rightCol.nextElementSibling;
                }

                // „É¢„Éº„ÉÄ„É´„Å™„Å©„ÅåÈñì„Å´„ÅÇ„ÇãÂ†¥Âêà„ÅÆÂØæÁ≠ñÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
                if (!leftCol || !rightCol) return;

                const startX = e.clientX;
                const startLeftWidth = leftCol.getBoundingClientRect().width;
                const startRightWidth = rightCol.getBoundingClientRect().width;

                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                const onMouseMove = (e) => {
                    const dx = e.clientX - startX;
                    // ÊúÄÂ∞èÂπÖ„ÉÅ„Çß„ÉÉ„ÇØ (50px)
                    if (startLeftWidth + dx > 50 && startRightWidth - dx > 50) {
                        leftCol.style.flex = `0 0 ${startLeftWidth + dx}px`;
                        rightCol.style.flex = `0 0 ${startRightWidth - dx}px`;
                    }
                };

                const onMouseUp = () => {
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });


        // Ë®≠ÂÆö„Éë„Éç„É´„ÅÆ„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
        const settingsHeader = document.getElementById("settingsHeader");
        let isDraggingSettings = false;
        let settingsStartX, settingsStartY;
        let settingsPanelWidth, settingsPanelHeight;
        let isTransformRemoved = false;

        settingsHeader.addEventListener("mousedown", (e) => {
            isDraggingSettings = true;

            // ÁèæÂú®„ÅÆ„Éë„Éç„É´‰ΩçÁΩÆ„ÇíÂèñÂæó
            const rect = settingsPanel.getBoundingClientRect();

            // „Éû„Ç¶„Çπ„ÅÆ„Éë„Éç„É´ÂÜÖ„Åß„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆó
            settingsStartX = e.clientX - rect.left;
            settingsStartY = e.clientY - rect.top;

            // „Éë„Éç„É´„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
            settingsPanelWidth = rect.width;
            settingsPanelHeight = rect.height;

            document.body.style.cursor = "move";
            document.body.style.userSelect = "none";
            e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
            if (!isDraggingSettings) return;

            // „Éû„Ç¶„Çπ‰ΩçÁΩÆ„Åã„Çâ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíÂºï„ÅÑ„Å¶„ÄÅ„Éë„Éç„É´„ÅÆÂ∑¶‰∏ä‰ΩçÁΩÆ„ÇíË®àÁÆó
            let newLeft = e.clientX - settingsStartX;
            let newTop = e.clientY - settingsStartY;

            // ÁîªÈù¢Â§ñ„Å´Âá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Èôê
            const maxLeft = window.innerWidth - settingsPanelWidth;
            const maxTop = window.innerHeight - settingsPanelHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            // ‰ΩçÁΩÆ„ÇíË®≠ÂÆö
            settingsPanel.style.left = `${newLeft}px`;
            settingsPanel.style.top = `${newTop}px`;
        });

        document.addEventListener("mouseup", () => {
            if (isDraggingSettings) {
                isDraggingSettings = false;
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }
        });
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´Ë®≠ÂÆö„Éë„Éç„É´„ÅÆ‰ΩçÁΩÆ„ÇíË™øÊï¥
        window.addEventListener("resize", () => {
            if (settingsPanel.style.display === "block") {
                adjustSettingsPanelPosition();
            }
        });
    </script>
</body>

</html>