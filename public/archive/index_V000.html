<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム + 設定パネル</title>
<style>
body { font-family: sans-serif; margin: 0; background:#f0f0f0; }
header { position: fixed; top:0; left:0; width:100%; background:#ddd; padding:5px 10px; z-index:100; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
input { padding: 3px; font-size: 1em; width: 100px; }
button { padding: 3px 8px; font-size: 1em; }
.container { display:flex; gap:10px; margin-top:60px; padding:10px; }

/* 各カラム */
.column { flex:1; border:1px solid #ccc; background:#fff; padding:5px; max-height:600px; overflow-y:auto; }

/* コメント */
#comment div { display:flex; align-items:center; margin-bottom:5px; }
#comment img { width:40px; height:40px; margin-right:5px; }

/* ギフト */
.giftItem { display:flex; align-items:center; background:#f9f9f9; padding:2px 5px; border-radius:5px; margin-bottom:5px; box-shadow:1px 1px 3px #aaa; }
.giftItem img { width:40px; height:40px; margin-right:5px; }

/* カラムヘッダー */
.column h2 { text-align:center; margin:5px 0; font-size:1.2em; }

/* 設定パネル */
#settingsPanel { display:none; position:absolute; right:10px; top:40px; background:#fff; border:1px solid #ccc; padding:5px; z-index:200; font-size:0.9em; }
#settingsPanel div { margin-bottom:5px; }

/* ステータス色 */
#statusSpan.connecting { color: blue; }
#statusSpan.connected { color: green; }
#statusSpan.disconnected { color: red; }
</style>
</head>
<body>

<header>
  <label>Room ID: <input type="text" id="roomInput" placeholder="例: 490133"></label>
  <button id="switchRoom">接続</button>
  <span id="statusSpan" class="disconnected">Status: 待機中</span>
  <span id="hbSpan">HB: 10s</span>
  <span id="kpSpan">KeyPoll: 5s</span>
  <span id="roomNameSpan">Room: -</span>
  <span id="startedSpan">開始: -</span>
  <span id="elapsedSpan">経過: -</span>

  <button id="toggleSettings" style="position:absolute; right:10px; top:5px;">設定</button>

  <div id="settingsPanel">
    <div><strong>コメント:</strong> 文字サイズ <input type="number" id="commentFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="commentColor" value="#000000"></div>
    <div><strong>有料ギフト:</strong> 文字サイズ <input type="number" id="paidFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="paidColor" value="#000000"></div>
    <div><strong>無料ギフト:</strong> 文字サイズ <input type="number" id="freeFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="freeColor" value="#000000"></div>
    <button id="applyDisplaySettings">適用</button>
  </div>
</header>

<div class="container">
    <div class="column">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>

    <div class="column">
        <h2>無料ギフト ⭐（ID:3000421）</h2>
        <div id="freeStar"></div>
    </div>

    <div class="column">
        <h2>無料ギフト（その他）</h2>
        <div id="freeOther"></div>
    </div>

    <div class="column">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
</div>

<script>
let broadcastKey = null;
let socket = null;
let startedAt = null;
let hbInterval = null;
let reconnectTimeout = null;

// 設定
let commentSettings = {size:14, color:"#000000"};
let paidSettings = {size:14, color:"#000000"};
let freeSettings = {size:14, color:"#000000"};

// ギフト累積管理
const paidGiftMap = {};
const freeGiftMap = {};
const freeStarMap = {};   // ID:3000421 の無料ギフト
const freeOtherMap = {};  // それ以外の無料ギフト


// 設定パネル表示
const settingsPanel = document.getElementById("settingsPanel");
document.getElementById("toggleSettings").onclick = () => {
    settingsPanel.style.display = (settingsPanel.style.display==="none")?"block":"none";
};

// 設定適用
document.getElementById("applyDisplaySettings").onclick = () => {
    commentSettings.size = parseInt(document.getElementById("commentFontSize").value);
    commentSettings.color = document.getElementById("commentColor").value;
    paidSettings.size = parseInt(document.getElementById("paidFontSize").value);
    paidSettings.color = document.getElementById("paidColor").value;
    freeSettings.size = parseInt(document.getElementById("freeFontSize").value);
    freeSettings.color = document.getElementById("freeColor").value;

    document.getElementById("comment").style.fontSize = commentSettings.size+"px";
    document.getElementById("comment").style.color = commentSettings.color;
    document.getElementById("paidGift").style.fontSize = paidSettings.size+"px";
    document.getElementById("paidGift").style.color = paidSettings.color;
    document.getElementById("freeGift").style.fontSize = freeSettings.size+"px";
    document.getElementById("freeGift").style.color = freeSettings.color;
};

// コメント表示
function showComment(c){
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `${c.ac}：${c.cm}`;
    div.appendChild(img);
    div.appendChild(p);
    document.getElementById("comment").prepend(div);
}

// ギフト表示（累積）
function showGift(g){
    const gt = parseInt(g.gt);
    let containerId, giftMap;

    // 無料ギフト（gt===2）
    if (gt === 2) {
        if (g.g === 3000421) {
            // 星（ID:3000421）
            containerId = "freeStar";
            giftMap = freeStarMap;
        } else {
            // その他無料ギフト
            containerId = "freeOther";
            giftMap = freeOtherMap;
        }
    }
    // 有料ギフト（gt!==2）
    else {
        containerId = "paidGift";
        giftMap = paidGiftMap;
    }


    const key = `${g.u}_${g.g}`;
    if(giftMap[key]){
        const item = giftMap[key];
        item.count += g.n;
        item.time = Date.now();

        // 表示更新
        item.div.querySelector("p").textContent = `${g.ac}：${item.count}個`;

        // 最新行としてトップに移動
        item.div.remove();
        document.getElementById(containerId).prepend(item.div);

        return;

    }

    const div = document.createElement("div");
    div.className="giftItem";
    const img1 = document.createElement("img");
    img1.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;
    const img2 = document.createElement("img");
    img2.src=`https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    img2.width=30;
    const p = document.createElement("p");
    p.textContent=`${g.ac}：${g.n}個`;
    div.appendChild(img1); div.appendChild(img2); div.appendChild(p);
    document.getElementById(containerId).prepend(div);

    giftMap[key] = { div: div, count: g.n, time: Date.now() };
}

// ステータス更新
function setStatus(status){
    const span = document.getElementById("statusSpan");
    span.className="";
    if(status==="connecting"){ span.textContent="Status: 再接続中"; span.classList.add("connecting"); }
    else if(status==="connected"){ span.textContent="Status: 接続中"; span.classList.add("connected"); }
    else { span.textContent="Status: 切断"; span.classList.add("disconnected"); }
}

// 接続
async function connectRoom(roomId){
    if(!roomId) return;
    if(reconnectTimeout) clearTimeout(reconnectTimeout);

    try{
        setStatus("connecting");
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        if(!json.broadcast_key){ alert("broadcast_key取得失敗"); return; }
        broadcastKey=json.broadcast_key;

        if(socket) socket.close();

        socket = new WebSocket("wss://online.showroom-live.com");
        socket.onopen = ()=>{
            socket.send("SUB\t"+broadcastKey);
            setStatus("connected");

            // ハートビート開始
            hbInterval = setInterval(()=>{
                if(socket && socket.readyState===WebSocket.OPEN) socket.send("PING");
            },10000);
        };

        socket.onmessage=(msg)=>{
            const data = msg.data;
            if(data.startsWith("ACK")||data.startsWith("ERR")) return;
            const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`,""));
            if(obj.cm) showComment(obj);
            else if(obj.g) showGift(obj);
            if(!startedAt && obj.started_at) startedAt=obj.started_at*1000;
            if(obj.main_name) document.getElementById("roomNameSpan").textContent="Room: "+obj.main_name;
        };

        socket.onclose = ()=>{
            setStatus("disconnected");
            if(hbInterval) clearInterval(hbInterval);
            // 5秒後に自動再接続
            reconnectTimeout = setTimeout(()=>connectRoom(roomId),5000);
        };


    }catch(e){
        console.error(e);
        setStatus("disconnected");
        // 5秒後に再接続
        reconnectTimeout = setTimeout(()=>connectRoom(roomId),5000);
    }
}

// 経過時間更新
setInterval(()=>{
    if(startedAt){
        const now=Date.now();
        const diff=Math.floor((now-startedAt)/1000);
        const h=Math.floor(diff/3600);
        const m=Math.floor((diff%3600)/60);
        const s=diff%60;
        document.getElementById("startedSpan").textContent="開始: "+new Date(startedAt).toLocaleString();
        document.getElementById("elapsedSpan").textContent=`経過: ${h}時間 ${m}分 ${s}秒`;
    }
},1000);

// ルーム切替ボタン
document.getElementById("switchRoom").onclick = ()=>{
    const newRoomId=document.getElementById("roomInput").value.trim();
    if(newRoomId) connectRoom(newRoomId);
};

// 初期ルーム
connectRoom(490133);
</script>
</body>
</html>
