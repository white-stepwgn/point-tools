<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>SR „Ç≥„É°„É≥„Éà„Éª„ÇÆ„Éï„Éà 3„Ç´„É©„É† + Ë®≠ÂÆö„Éë„Éç„É´</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ddd;
            padding: 5px 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            /* Á∏¶‰∏¶„Å≥„Å´Â§âÊõ¥ */
            gap: 5px;
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        input {
            padding: 3px;
            font-size: 1em;
            width: 100px;
        }

        button {
            padding: 3px 8px;
            font-size: 1em;
        }

        .container {
            display: flex;
            gap: 10px;
            margin-top: 80px;
            /* „Éò„ÉÉ„ÉÄ„Éº„ÅåÈ´ò„Åè„Å™„Å£„Åü„ÅÆ„ÅßË™øÊï¥ */
            padding: 10px;
        }

        /* ÂêÑ„Ç´„É©„É† */
        .column {
            flex: 1;
            border: 1px solid #ccc;
            background: #fff;
            padding: 5px;
            height: 600px;
            overflow-y: auto;
        }

        /* „Ç≥„É°„É≥„Éà */
        #comment div {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 5px;
            background: #f9f9f9;
            padding: 2px 5px;
            border-radius: 5px;
            box-shadow: 1px 1px 3px #aaa;
        }

        #comment img {
            width: 40px;
            height: 40px;
            margin-right: 5px;
            flex-shrink: 0;
        }

        #comment .comment-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            box-shadow: none;
        }

        #comment .comment-name {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 2px;
            text-align: left;
        }

        #comment .comment-text {
            margin-left: 0;
            margin-top: 0;
        }

        /* „ÇÆ„Éï„Éà */
        .giftItem {
            display: flex;
            align-items: center;
            background: #f9f9f9;
            padding: 2px 5px;
            border-radius: 5px;
            margin-bottom: 5px;
            box-shadow: 1px 1px 3px #aaa;
        }

        .giftItem img {
            width: 40px;
            height: 40px;
            margin-right: 5px;
        }

        /* „ÇÆ„Éï„ÉàÔºà„Ç≥„É°„É≥„ÉàÊ¨Ñ„Å®Âêå„Åò„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */
        #freeStar .giftItem,
        #freeOther .giftItem,
        #paidGift .giftItem {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        #freeStar .giftItem img:first-child,
        #freeOther .giftItem img:first-child,
        #paidGift .giftItem img:first-child {
            width: 40px;
            height: 40px;
            margin-right: 5px;
            flex-shrink: 0;
        }

        #freeStar .giftItem .gift-content,
        #freeOther .giftItem .gift-content,
        #paidGift .giftItem .gift-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-between;
            min-height: 40px;
        }

        #freeStar .giftItem .gift-name,
        #freeOther .giftItem .gift-name,
        #paidGift .giftItem .gift-name {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 2px;
            align-self: flex-start;
            text-align: left;
        }

        #freeStar .giftItem .gift-text,
        #freeOther .giftItem .gift-text,
        #paidGift .giftItem .gift-text {
            margin-left: 0;
            align-self: flex-start;
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        #freeStar .giftItem .gift-text img,
        #freeOther .giftItem .gift-text img,
        #paidGift .giftItem .gift-text img {
            width: 30px;
            height: 30px;
            margin: 0;
        }

        /* „Ç´„É©„É†„Éò„ÉÉ„ÉÄ„Éº */
        .column h2 {
            text-align: center;
            margin: 5px 0;
            font-size: 1.2em;
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        #settingsPanel {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            z-index: 1000;
            font-size: 1em;
            width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 5px;
        }

        #settingsPanel div {
            margin-bottom: 5px;
        }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ */
        #statusSpan.connecting {
            color: blue;
        }

        #statusSpan.connected {
            color: green;
        }

        /* „Ç¢„É©„Éº„É†„É¢„Éº„ÉÄ„É´ */
        #alarmModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            text-align: center;
            width: 300px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ÈÄöÁü•„É¢„Éº„ÉÄ„É´ */
        #notificationModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 30px;
            z-index: 2100;
            /* „Ç¢„É©„Éº„É†Ë®≠ÂÆö„Çà„Çä‰∏ä */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            text-align: center;
            width: 320px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #notificationModal h3 {
            margin-top: 0;
            color: #d32f2f;
            font-size: 1.5em;
        }

        #notificationModal p {
            font-size: 1.2em;
            margin: 20px 0;
        }

        #notificationModal button {
            padding: 12px 30px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            background: #2196F3;
            color: white;
            transition: opacity 0.2s;
        }

        #notificationModal button:hover {
            opacity: 0.9;
        }

        #alarmModal h3 {
            margin-top: 0;
        }

        #alarmModal input[type="text"] {
            font-size: 2.5em;
            padding: 15px;
            margin: 10px 0 20px 0;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            letter-spacing: 2px;
            font-weight: 300;
            background: transparent;
            border: none;
            border-bottom: 2px solid #eee;
            color: #333;
            outline: none;
        }

        /* „ÉÜ„É≥„Ç≠„Éº */
        .tenkey-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .tenkey-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5em;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            transition: background 0.2s, transform 0.1s;
            color: #333;
        }

        .tenkey-btn:hover {
            background: #e0e0e0;
        }

        .tenkey-btn:active {
            background: #d0d0d0;
            transform: scale(0.95);
        }

        .tenkey-btn.clear {
            background: #fff0f0;
            color: #d32f2f;
            font-size: 1em;
            font-weight: bold;
        }

        .tenkey-btn.clear:hover {
            background: #ffcccc;
        }

        #alarmModal .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        #alarmModal button.action-btn {
            flex: 1;
            padding: 12px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        #alarmModal button.action-btn:hover {
            opacity: 0.8;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1500;
        }
    </style>
</head>

<body>

    <div id="overlay"></div>
    <div id="alarmModal">
        <h3>„Ç¢„É©„Éº„É†Ë®≠ÂÆö</h3>
        <input type="text" id="alarmTimeInput" placeholder="--:--" readonly>

        <div class="tenkey-grid">
            <button class="tenkey-btn" onclick="inputTenkey(1)">1</button>
            <button class="tenkey-btn" onclick="inputTenkey(2)">2</button>
            <button class="tenkey-btn" onclick="inputTenkey(3)">3</button>
            <button class="tenkey-btn" onclick="inputTenkey(4)">4</button>
            <button class="tenkey-btn" onclick="inputTenkey(5)">5</button>
            <button class="tenkey-btn" onclick="inputTenkey(6)">6</button>
            <button class="tenkey-btn" onclick="inputTenkey(7)">7</button>
            <button class="tenkey-btn" onclick="inputTenkey(8)">8</button>
            <button class="tenkey-btn" onclick="inputTenkey(9)">9</button>
            <button class="tenkey-btn clear" onclick="clearTenkey()">C</button>
            <button class="tenkey-btn" onclick="inputTenkey(0)">0</button>
            <button class="tenkey-btn" onclick="backspaceTenkey()">‚å´</button>
        </div>

        <div class="modal-buttons">
            <button id="alarmSetConfirmBtn" class="action-btn" style="background:#4CAF50; color:white;">Ë®≠ÂÆö</button>
            <button id="alarmClearBtn" class="action-btn" style="background:#f44336; color:white;">Ëß£Èô§</button>
        </div>
        <div style="margin-top:15px;">
            <button id="alarmCancelBtn" class="action-btn"
                style="width:100%; background:#9e9e9e; color:white;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div id="notificationModal">
        <h3>üîî „Ç¢„É©„Éº„É†</h3>
        <p id="notificationMessage">ÊôÇÈñì„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ</p>
        <button id="notificationOkBtn">OK</button>
    </div>

    <header>
        <div class="header-row">
            <label>Room ID: <input type="text" id="roomInput" placeholder="‰æã: 490133"></label>
            <button id="switchRoom">Êé•Á∂ö</button>
            <span id="statusSpan" class="disconnected">Status: ÂæÖÊ©ü‰∏≠</span>
            <span id="hbSpan">HB: 10s</span>
            <span id="kpSpan">KeyPoll: 5s</span>
            <span id="roomNameSpan">Room: -</span>
            <span id="currentLiveStartedAtSpan">Êú™ÈÖç‰ø°</span>
            <span id="currentLiveElapsedSpan">ÁµåÈÅéÊôÇÈñì: -</span>
        </div>
        <div class="header-row">
            <span id="clockSpan" style="font-weight:bold; font-size:1.1em;">--:--:--</span>
            <button id="alarmSetBtn">„Ç¢„É©„Éº„É†„Çª„ÉÉ„Éà</button>
            <span id="alarmStatusSpan" style="color: #d00; display:none;">üîî <span id="alarmTimeDisplay"></span></span>
        </div>
    </header>

    <div class="container">
        <div class="column">
            <div style="display:flex; justify-content:center; align-items:center; position:relative;">
                <h2>„Ç≥„É°„É≥„Éà</h2>
                <button id="toggleSettings" style="position:absolute; right:0; font-size:0.8em;">Ë®≠ÂÆö</button>

                <div id="settingsPanel">
                    <div><strong>„Ç≥„É°„É≥„Éà:</strong> ÊñáÂ≠ó„Çµ„Ç§„Ç∫ <input type="number" id="commentFontSize" value="14" min="10"
                            max="30"> px
                        Ëâ≤ <input type="color" id="commentColor" value="#000000"></div>
                    <button id="applyDisplaySettings">ÈÅ©Áî®</button>
                </div>
            </div>
            <div id="comment"></div>
        </div>

        <div class="column">
            <h2>ÁÑ°Êñô„ÇÆ„Éï„Éà ‚≠ê</h2>
            <div id="freeStar"></div>
        </div>

        <div class="column">
            <h2>ÁÑ°Êñô„ÇÆ„Éï„ÉàÔºà„Åù„ÅÆ‰ªñÔºâ</h2>
            <div id="freeOther"></div>
        </div>

        <div class="column">
            <h2>ÊúâÊñô„ÇÆ„Éï„Éà</h2>
            <div id="paidGift"></div>
        </div>
    </div>


    <script>
        let broadcastKey = null;
        let socket = null;
        let startedAt = null;
        let hbInterval = null;
        let reconnectTimeout = null;

        // „Ç¢„É©„Éº„É†Áî®
        let alarmTime = null; // "HH:MM" string
        let alarmTriggered = false;

        // ÊôÇË®àÊõ¥Êñ∞
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("clockSpan").textContent = `${h}:${m}:${s}`;

            // „Ç¢„É©„Éº„É†„ÉÅ„Çß„ÉÉ„ÇØ
            if (alarmTime && !alarmTriggered) {
                const currentHM = `${h}:${m}`;
                if (currentHM === alarmTime) {
                    alarmTriggered = true;
                    // alert(`„Ç¢„É©„Éº„É†: ${alarmTime} „Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`); // ÂªÉÊ≠¢

                    // „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                    document.getElementById("notificationMessage").textContent = `${alarmTime} „Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`;
                    document.getElementById("notificationModal").style.display = "block";
                    document.getElementById("overlay").style.display = "block";

                    // „Ç¢„É©„Éº„É†„É™„Çª„ÉÉ„Éà
                    alarmTime = null;
                    document.getElementById("alarmStatusSpan").style.display = "none";
                }
            }
        }, 1000);

        // ÈÄöÁü•„É¢„Éº„ÉÄ„É´„ÅÆOK„Éú„Çø„É≥
        document.getElementById("notificationOkBtn").onclick = () => {
            document.getElementById("notificationModal").style.display = "none";
            // „Ç¢„É©„Éº„É†Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇÇÈñâ„Åò„Çã
            if (document.getElementById("alarmModal").style.display !== "block") {
                document.getElementById("overlay").style.display = "none";
            }
        };

        // „Ç¢„É©„Éº„É†Ë®≠ÂÆö„Éú„Çø„É≥Ôºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ
        const alarmModal = document.getElementById("alarmModal");
        const overlay = document.getElementById("overlay");
        const alarmTimeInput = document.getElementById("alarmTimeInput");

        let tenkeyBuffer = ""; // ÂÖ•Âäõ„Éê„ÉÉ„Éï„Ç° (‰æã: "1230")

        function updateTimeDisplay() {
            // „Éê„ÉÉ„Éï„Ç°„Çí HH:MM ÂΩ¢Âºè„Å´Êï¥ÂΩ¢„Åó„Å¶Ë°®Á§∫
            let display = "--:--";
            if (tenkeyBuffer.length > 0) {
                let h = tenkeyBuffer.substring(0, 2);
                let m = tenkeyBuffer.substring(2, 4);

                // „Éë„Éá„Ç£„É≥„Ç∞„ÇÑ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂá¶ÁêÜ
                if (tenkeyBuffer.length === 1) display = `${h}-:--`;
                else if (tenkeyBuffer.length === 2) display = `${h}:--`;
                else if (tenkeyBuffer.length === 3) display = `${h}:${m.charAt(0)}-`;
                else if (tenkeyBuffer.length === 4) display = `${h}:${m}`;
            }
            alarmTimeInput.value = display;
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨ÈñãÔºàHTML„ÅÆonclick„Åã„ÇâÂëº„Å∂„Åü„ÇÅÔºâ
        window.inputTenkey = (num) => {
            if (tenkeyBuffer.length < 4) {
                tenkeyBuffer += num;
                updateTimeDisplay();
            }
        };

        window.clearTenkey = () => {
            tenkeyBuffer = "";
            updateTimeDisplay();
        };

        window.backspaceTenkey = () => {
            if (tenkeyBuffer.length > 0) {
                tenkeyBuffer = tenkeyBuffer.slice(0, -1);
                updateTimeDisplay();
            }
        };

        function closeAlarmModal() {
            alarmModal.style.display = "none";
            overlay.style.display = "none";
        }

        document.getElementById("alarmSetBtn").onclick = () => {
            // ÂàùÊúüÂåñ
            tenkeyBuffer = "";

            // ÁèæÂú®ÊôÇÂàª„ÇíÂàùÊúüÂÄ§„Å®„Åó„Å¶„Çª„ÉÉ„Éà„Åô„Çã„Åã„ÄÅÁ©∫„Å´„Åô„Çã„Åã
            // „ÉÜ„É≥„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØÁ©∫„ÅÆÊñπ„ÅåÊâì„Å°„ÇÑ„Åô„ÅÑ„Åã„ÇÇÔºü
            // Ë¶ÅÊúõ„Åå„ÅÇ„Çå„Å∞ÁèæÂú®ÊôÇÂàª„Çª„ÉÉ„Éà„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ‰ªäÂõû„ÅØÁ©∫„Çπ„Çø„Éº„Éà„Å´„Åô„Çã

            updateTimeDisplay();

            alarmModal.style.display = "block";
            overlay.style.display = "block";
        };

        // Ë®≠ÂÆöÁ¢∫ÂÆö
        // Ë®≠ÂÆöÁ¢∫ÂÆö
        document.getElementById("alarmSetConfirmBtn").onclick = () => {
            if (tenkeyBuffer.length === 4) {
                const h = parseInt(tenkeyBuffer.substring(0, 2));
                const m = parseInt(tenkeyBuffer.substring(2, 4));

                // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
                    alarmTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    alarmTriggered = false;
                    document.getElementById("alarmTimeDisplay").textContent = alarmTime;
                    document.getElementById("alarmStatusSpan").style.display = "inline";
                    closeAlarmModal();
                } else {
                    alert("ÁÑ°Âäπ„Å™ÊôÇÂàª„Åß„Åô");
                }
            } else {
                alert("ÊôÇÂàª„Çí4Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (‰æã: 1230)");
            }
        };

        // Ëß£Èô§
        document.getElementById("alarmClearBtn").onclick = () => {
            alarmTime = null;
            document.getElementById("alarmStatusSpan").style.display = "none";
            closeAlarmModal();
        };

        // „Ç≠„É£„É≥„Çª„É´
        document.getElementById("alarmCancelBtn").onclick = closeAlarmModal;
        overlay.onclick = closeAlarmModal;

        // Ë®≠ÂÆö
        let commentSettings = { size: 14, color: "#000000" };

        // „ÇÆ„Éï„ÉàÁ¥ØÁ©çÁÆ°ÁêÜ
        const paidGiftMap = {};
        const freeGiftMap = {};
        const freeStarMap = {};   // ID:3000421 „ÅÆÁÑ°Êñô„ÇÆ„Éï„Éà
        const freeOtherMap = {};  // „Åù„Çå‰ª•Â§ñ„ÅÆÁÑ°Êñô„ÇÆ„Éï„Éà

        // „ÇÆ„Éï„Éà„Éû„Çπ„Çø„Éº„Éá„Éº„Çø (ID -> {name, point, free})
        const giftMasterData = {};


        // Ë®≠ÂÆö„Éë„Éç„É´Ë°®Á§∫
        const settingsPanel = document.getElementById("settingsPanel");

        document.getElementById("toggleSettings").onclick = () => {
            settingsPanel.style.display = (settingsPanel.style.display === "none") ? "block" : "none";
        };

        // Ë®≠ÂÆöÈÅ©Áî®
        document.getElementById("applyDisplaySettings").onclick = () => {
            commentSettings.size = parseInt(document.getElementById("commentFontSize").value);
            commentSettings.color = document.getElementById("commentColor").value;

            document.getElementById("comment").style.fontSize = commentSettings.size + "px";
            document.getElementById("comment").style.color = commentSettings.color;

            // „Éë„Éç„É´„ÇíÈñâ„Åò„Çã
            settingsPanel.style.display = "none";
        };

        // „Ç≥„É°„É≥„ÉàË°®Á§∫
        function showComment(c) {
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.alignItems = "flex-start";   // ‰∏äÊèÉ„Åà
            div.style.marginBottom = "5px";
            div.style.background = "#f9f9f9";
            div.style.padding = "2px 5px";
            div.style.borderRadius = "5px";
            div.style.boxShadow = "1px 1px 3px #aaa";

            // „Ç¢„Éê„Çø„ÉºÁîªÂÉè
            const img = document.createElement("img");
            img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
            img.style.width = "40px";
            img.style.height = "40px";
            img.style.marginRight = "5px";
            img.style.flexShrink = "0";

            // „Ç≥„É°„É≥„ÉàÂêç„ÉªÊú¨Êñá„É©„ÉÉ„Éë„Éº
            const wrapperDiv = document.createElement("div");
            wrapperDiv.style.display = "flex";
            wrapperDiv.style.flexDirection = "column";
            wrapperDiv.style.alignItems = "flex-start";  // Â∑¶ÂØÑ„Åõ
            wrapperDiv.style.flex = "1";

            const nameSpan = document.createElement("span");
            nameSpan.className = "comment-name";
            nameSpan.textContent = c.ac;
            nameSpan.style.color = "#999";
            nameSpan.style.fontSize = "0.9em";
            nameSpan.style.marginBottom = "2px";
            nameSpan.style.textAlign = "left";

            const textP = document.createElement("p");
            textP.className = "comment-text";
            textP.textContent = c.cm;
            textP.style.margin = "0";
            textP.style.textAlign = "left";

            wrapperDiv.appendChild(nameSpan);
            wrapperDiv.appendChild(textP);

            div.appendChild(img);
            div.appendChild(wrapperDiv);

            document.getElementById("comment").prepend(div);
        }


        // „ÇÆ„Éï„ÉàË°®Á§∫ÔºàÁ¥ØÁ©çÔºâ
        function showGift(g) {
            const gt = parseInt(g.gt);
            let containerId, giftMap;

            // ÁÑ°Êñô„ÇÆ„Éï„ÉàÔºàgt===2Ôºâ
            if (gt === 2) {
                if (g.g === 3000421) {
                    // ÊòüÔºàID:3000421Ôºâ
                    containerId = "freeStar";
                    giftMap = freeStarMap;
                } else {
                    // „Åù„ÅÆ‰ªñÁÑ°Êñô„ÇÆ„Éï„Éà
                    containerId = "freeOther";
                    giftMap = freeOtherMap;
                }
            }
            // ÊúâÊñô„ÇÆ„Éï„ÉàÔºàgt!==2Ôºâ
            else {
                containerId = "paidGift";
                giftMap = paidGiftMap;
            }


            const key = `${g.u}_${g.g}`;

            if (giftMap[key]) {
                const item = giftMap[key];
                item.count += g.n;
                item.time = Date.now();

                // Ë°®Á§∫Êõ¥Êñ∞ÔºàÂÖ®„ÇÆ„Éï„ÉàÂÖ±ÈÄö„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
                const nameSpan = item.div.querySelector(".gift-name");
                const textP = item.div.querySelector(".gift-text");
                if (nameSpan) nameSpan.textContent = g.ac;
                if (textP) {
                    // „ÇÆ„Éï„ÉàÁîªÂÉè„Å®ÂÄãÊï∞„ÇíÊõ¥Êñ∞
                    const giftImg = textP.querySelector("img");
                    if (giftImg) {
                        giftImg.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
                        // Êõ¥Êñ∞ÊôÇ„ÇÇ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíË®≠ÂÆö
                        if (giftMasterData[g.g]) {
                            const info = giftMasterData[g.g];
                            const unit = info.free ? "pt" : "G";
                            giftImg.title = `${info.name}\n${info.point}${unit}`;
                        }
                    }
                    const countSpan = textP.querySelector(".gift-count");
                    if (countSpan) {
                        countSpan.textContent = `${item.count}ÂÄã`;
                    }
                }

                // ÊúÄÊñ∞Ë°å„Å®„Åó„Å¶„Éà„ÉÉ„Éó„Å´ÁßªÂãï
                item.div.remove();
                document.getElementById(containerId).prepend(item.div);

                return;

            }

            const div = document.createElement("div");
            div.className = "giftItem";

            // ÂÖ®„ÇÆ„Éï„ÉàÂÖ±ÈÄö„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà
            const img1 = document.createElement("img");
            img1.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;

            // „ÇÆ„Éï„ÉàÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å´‰æ°Ê†º„ÇíË°®Á§∫
            const giftInfo = giftMasterData[g.g];
            if (giftInfo) {
                // img1.title = `${giftInfo.name}: ${giftInfo.point}pt`; // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„Åß„ÅØ„Å™„Åè„ÇÆ„Éï„ÉàÁîªÂÉè„Å´„Å§„Åë„Çã„Åπ„Åç„ÅãÔºü
                // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÅØ„ÄåÊúâÊñô„ÇÆ„Éï„Éà„ÅÆ„Éû„Ç¶„Çπ„Ç™„Éº„Éê„Éº„Åó„ÅüÈöõ„Å´„Äç„Å™„ÅÆ„Åß„ÄÅ„ÇÆ„Éï„ÉàÁîªÂÉè„Å´„Å§„Åë„Çã„ÅÆ„ÅåÈÅ©Âàá
            }

            const contentDiv = document.createElement("div");
            contentDiv.className = "gift-content";

            const nameSpan = document.createElement("span");
            nameSpan.className = "gift-name";
            nameSpan.textContent = g.ac;

            const textP = document.createElement("p");
            textP.className = "gift-text";

            const giftImg = document.createElement("img");
            giftImg.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;

            // „ÇÆ„Éï„ÉàÁîªÂÉè„Å´‰æ°Ê†ºÊÉÖÂ†±„Çí„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å®„Åó„Å¶Ë®≠ÂÆö
            if (giftMasterData[g.g]) {
                const info = giftMasterData[g.g];
                const ptLabel = info.free ? "" : "G"; // ÁÑ°Êñô„Å™„ÇâÂçò‰Ωç„Å™„Åó„Åãpt„Åã„ÄÅÊúâÊñô„Å™„ÇâG„Åã„ÄÇAPI„ÅØpoint„ÄÇ
                // Showroom„ÅØÊúâÊñô„ÇÆ„Éï„Éà„ÅØGold(G)„ÄÅÁÑ°Êñô„ÅØPoint(pt)„Å†„Åå„ÄÅAPI„ÅÆpoint„Éï„Ç£„Éº„É´„Éâ„ÅØÂÖ±ÈÄö„ÄÇ
                // „Çè„Åã„Çä„ÇÑ„Åô„Åè "100pt" „ÇÑ "100G" „Å®„Åô„Çã„Åã„ÄÅÂçò„Å´ "100" „Å®„Åô„Çã„Åã„ÄÇ
                // Ë¶ÅÊúõ„ÅØ„ÄåÈáëÈ°ç„ÇíË¶ã„Çå„Çã„Çà„ÅÜ„Å´„Äç„Å™„ÅÆ„Åß„ÄÅÂçò‰Ωç„Çí„Å§„Åë„Çã„ÄÇ
                const unit = info.free ? "pt" : "G";
                giftImg.title = `${info.name}\n${info.point}${unit}`;
            }

            const multiplySpan = document.createElement("span");
            multiplySpan.textContent = "√ó";

            const countSpan = document.createElement("span");
            countSpan.className = "gift-count";
            countSpan.textContent = `${g.n}ÂÄã`;

            textP.appendChild(giftImg);
            textP.appendChild(multiplySpan);
            textP.appendChild(countSpan);

            contentDiv.appendChild(nameSpan);
            contentDiv.appendChild(textP);

            div.appendChild(img1);
            div.appendChild(contentDiv);

            document.getElementById(containerId).prepend(div);

            giftMap[key] = { div: div, count: g.n, time: Date.now() };
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function setStatus(status) {
            const span = document.getElementById("statusSpan");
            span.className = "";
            if (status === "connecting") { span.textContent = "Status: ÂÜçÊé•Á∂ö‰∏≠"; span.classList.add("connecting"); }
            else if (status === "connected") { span.textContent = "Status: Êé•Á∂ö‰∏≠"; span.classList.add("connected"); }
            else { span.textContent = "Status: ÂàáÊñ≠"; span.classList.add("disconnected"); }
        }

        // Êé•Á∂ö
        async function connectRoom(roomId) {
            if (!roomId) return;
            if (reconnectTimeout) clearTimeout(reconnectTimeout);

            // „É™„Çª„ÉÉ„Éà
            startedAt = null;
            document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
            document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";

            try {
                setStatus("connecting");

                // current_live_started_at ÂèñÂæó
                try {
                    const profileRes = await fetch(`/room_profile?room_id=${roomId}`);
                    const profileJson = await profileRes.json();
                    if (profileJson.current_live_started_at) {
                        startedAt = profileJson.current_live_started_at * 1000;
                        const startedAtDate = new Date(startedAt);
                        document.getElementById("currentLiveStartedAtSpan").textContent =
                            `ÈÖç‰ø°ÈñãÂßã: ${startedAtDate.toLocaleString()}`;
                    } else {
                        startedAt = null;
                        document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
                        document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
                    }

                    if (profileJson.room_name) {
                        document.getElementById("roomNameSpan").textContent = "Room: " + profileJson.room_name;
                    } else {
                        document.getElementById("roomNameSpan").textContent = "Room: -";
                    }
                } catch (e) {
                    console.warn("room_profileÂèñÂæóÂ§±Êïó:", e);
                    startedAt = null;
                    document.getElementById("currentLiveStartedAtSpan").textContent = "Êú™ÈÖç‰ø°";
                    document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
                }

                // „ÇÆ„Éï„Éà„É™„Çπ„ÉàÂèñÂæó
                try {
                    const giftRes = await fetch(`/gift_list?room_id=${roomId}`);
                    const giftJson = await giftRes.json();

                    // normal„Å®enquete„Çí„Éû„Éº„Ç∏„Åó„Å¶„Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Çí‰ΩúÊàê
                    const processGifts = (list) => {
                        if (!list) return;
                        list.forEach(item => {
                            giftMasterData[item.gift_id] = {
                                name: item.gift_name,
                                point: item.point,
                                free: item.free
                            };
                        });
                    };

                    processGifts(giftJson.normal);
                    processGifts(giftJson.enquete);
                    console.log("Gift data loaded:", Object.keys(giftMasterData).length);

                } catch (e) {
                    console.warn("gift_listÂèñÂæóÂ§±Êïó:", e);
                }

                const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
                const json = await res.json();
                if (!json.broadcast_key) { alert("broadcast_keyÂèñÂæóÂ§±Êïó"); return; }
                broadcastKey = json.broadcast_key;

                if (socket) socket.close();

                socket = new WebSocket("wss://online.showroom-live.com");
                socket.onopen = () => {
                    socket.send("SUB\t" + broadcastKey);
                    setStatus("connected");

                    // „Éè„Éº„Éà„Éì„Éº„ÉàÈñãÂßã
                    hbInterval = setInterval(() => {
                        if (socket && socket.readyState === WebSocket.OPEN) socket.send("PING");
                    }, 10000);
                };

                socket.onmessage = (msg) => {
                    const data = msg.data;
                    if (data.startsWith("ACK") || data.startsWith("ERR")) return;
                    const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`, ""));
                    if (obj.cm) showComment(obj);
                    else if (obj.g) showGift(obj);
                    // current_live_started_at„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅWebSocket„Åã„Çâ„ÅÆstarted_at„Çí‰ΩøÁî®
                    if (!startedAt && obj.started_at) {
                        startedAt = obj.started_at * 1000;
                        const startedAtDate = new Date(startedAt);
                        document.getElementById("currentLiveStartedAtSpan").textContent =
                            `ÈÖç‰ø°ÈñãÂßã: ${startedAtDate.toLocaleString()}`;
                    }
                    if (obj.main_name) document.getElementById("roomNameSpan").textContent = "Room: " + obj.main_name;
                };

                socket.onclose = (event) => {
                    console.log("WebSocket closed:", event.code, event.reason);
                    setStatus("disconnected");
                    if (hbInterval) clearInterval(hbInterval);
                    // 5ÁßíÂæå„Å´Ëá™ÂãïÂÜçÊé•Á∂ö
                    reconnectTimeout = setTimeout(() => connectRoom(roomId), 5000);
                };

                socket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };


            } catch (e) {
                console.error(e);
                setStatus("disconnected");
                // 5ÁßíÂæå„Å´ÂÜçÊé•Á∂ö
                reconnectTimeout = setTimeout(() => connectRoom(roomId), 5000);
            }
        }

        // ÁµåÈÅéÊôÇÈñìÊõ¥Êñ∞
        setInterval(() => {
            if (startedAt) {
                const now = Date.now();
                const diff = Math.floor((now - startedAt) / 1000);
                const h = Math.floor(diff / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                document.getElementById("currentLiveElapsedSpan").textContent = `ÁµåÈÅéÊôÇÈñì: ${h}ÊôÇÈñì ${m}ÂàÜ ${s}Áßí`;
            } else {
                document.getElementById("currentLiveElapsedSpan").textContent = "ÁµåÈÅéÊôÇÈñì: -";
            }
        }, 1000);

        // „É´„Éº„É†ÂàáÊõø„Éú„Çø„É≥
        document.getElementById("switchRoom").onclick = () => {
            const newRoomId = document.getElementById("roomInput").value.trim();
            if (newRoomId) connectRoom(newRoomId);
        };

        // ÂàùÊúü„É´„Éº„É†
        connectRoom(490133);
    </script>
</body>

</html>